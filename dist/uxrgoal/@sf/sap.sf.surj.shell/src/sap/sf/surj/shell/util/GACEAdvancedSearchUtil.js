sap.ui.define('sap/sf/surj/shell/util/GACEAdvancedSearchUtil',['jquery.sap.global','sap/sf/surj/shell/util/DeferredUtil','sap/sf/surj/shell/util/SearchUtil','sap/m/MessageBox','../library'],function($,D,S,M){var r=sap.ui.getCore().getLibraryResourceBundle('sap.sf.surj.shell.i18n');var a={oDataV2:{initializer:{type:'ODataService',method:'POST',serviceName:'advancedSearchGetRenderingInformation',baseUrl:'/odata/v2/restricted/'},searchField:{type:'ODataService',method:'POST',serviceName:'advancedSearchFieldDataProvider',baseUrl:'/odata/v2/restricted/'},searchResult:{type:'ODataService',method:'POST',serviceName:'advancedSearchFindPersons',baseUrl:'/odata/v2/restricted/'}},oDataV4:{initializer:{type:'ODataService',method:'POST',serviceName:'advancedSearchGetRenderingInformation',baseUrl:'/odata/v4/PersonSearch.svc/'},searchField:{type:'ODataService',method:'POST',serviceName:'advancedSearchFieldDataProvider',baseUrl:'/odata/v4/PersonSearch.svc/'},searchResult:{type:'ODataService',method:'POST',serviceName:'advancedSearchFindPersons',baseUrl:'/odata/v4/PersonSearch.svc/'}}};var b='oDataV2';function c(C,p,t){var B=C.bindingContext;var F=B.getObject();var m=B.getModel();var o=m.getProperty('/oDataServiceKey')||b;var e=new sap.ui.model.json.JSONModel();var h=F.parentFields;if(h&&h.length>0){for(var j=0;j<h.length;j++){var i=m.getProperty('/selectedFieldValues/'+h[j]);var k="/"+h[j];if(i&&i.code){e.setProperty(k,i.id);}}}var l=p+1;var n={"searchField":F.field,"searchText":C.searchValue,"parentValues":e.oData,"pageNumber":l};if(n.parentValues&&o!==b){n.parentValues=Object.keys(n.parentValues).reduce(function(u,v){u.push({key:v,value:n.parentValues[v]});return u;},[]);}t=t||0;var q=$.extend({data:n},a[o].searchField);return D.invokeService(q).then(function(R){var I;var H=false;var T;if(o===b){I=R.AdvancedSearchFieldResponse.results.results;T=R.AdvancedSearchFieldResponse.totalNumberOfRecords;}else{I=R.results;T=R.totalNumberOfRecords;}if(I&&I.length>0){t+=I.length;H=t<T;}var u={items:I,hasMore:H,more:H?function(){return c(C,p+1,t);}:null};return u;});}function d(C,p,t,e){var h=$.extend({page:p+1,startIndex:parseInt(e)||0},C);var o=C.oDataVersion||b;delete h.oDataVersion;t=t||0;for(var k in h){var l=h[k].toString();if(l.toUpperCase()=="YES"){h[k]=true;}else if(l.toUpperCase()=="NO"){h[k]=false;}if(k=="displayLocation"){h.includeLocationInfoPerEmpl=h[k];delete h.displayLocation;}if(k=="includeHomeEmpl"){h.includeHomeAssignment=h[k];delete h.includeHomeEmpl;}if(k=="includeExternalPersons"){h.includeExternalUsers=h[k];delete h.includeExternalPersons;}if(k=="includeExternalPersonType"){if(h[k].trim()==""){delete h.includeExternalPersonType;}}if(k=="dynamicGroupId"){if(h[k].trim()==""){delete h.dynamicGroupId;}}}var m=$.extend({data:h},a[o].searchResult);if(o!==b){var n=m.data&&m.data.searchParameters;if(n){for(var i=0,j,I;i<n.length;i++){I=n[i];if(I&&I.ids instanceof Array){for(j=0;j<I.ids.length;j++){I.ids[j]=''+I.ids[j];}}}}}var q=D.invokeService(m).then(function(R){var u;var T;var v;var H=false;if(o===b){u=R.PeopleSearchListEntity.columnVisiblity.results;v=R.PeopleSearchListEntity.items.results;T=parseInt(R.PeopleSearchListEntity.totalCount)||0;H=R.PeopleSearchListEntity.hasMore;}else{u=R.columnVisiblity;v=R.items;T=parseInt(R.totalCount)||0;H=R.hasMore;}for(var x=0;x<v.length;x++){if(v[x].employments&&v[x].employments.results){v[x].employments=v[x].employments.results;}}if(v&&v.length>0){t+=v.length;(typeof H==='boolean')||(H=t<T);}var w=Math.max.apply(Math,v.map(function(I){return isNaN(I.indexRef)?0:I.indexRef;}));var y={columnVisibility:u,items:v,hasMore:H,more:H?function(){return d(C,p+1,t,w+1);}:null};return y;});s(q);return q;}function g(o){var e=o.oDataServiceKey||b;var R={data:{activeFields:o&&o.fieldIds||[]}};if(e===b){R.additionalCriteria=o&&o.additionalCriteria||[];}R=$.extend(R,a[e].initializer);return D.invokeService(R).then(function(h){if(e===b){for(var j=0;j<h.length;j++){h[j].childFields=h[j].childFields.results;h[j].parentFields=h[j].parentFields.results;h[j].fieldListValue=h[j].fieldListValue&&h[j].fieldListValue.results?h[j].fieldListValue.results:h[j].fieldListValue;h[j].fieldListValueLabel=h[j].fieldListValueLabel&&h[j].fieldListValueLabel.results?h[j].fieldListValueLabel.results:h[j].fieldListValueLabel;}}else{h=h.value;for(var j=0;j<h.length;j++){h[j].fieldListValue=h[j].fieldListValue&&h[j].fieldListValue.results?h[j].fieldListValue.results:h[j].fieldListValue;h[j].fieldListValueLabel=h[j].fieldListValueLabel&&h[j].fieldListValueLabel.results?h[j].fieldListValueLabel.results:h[j].fieldListValueLabel;}}var k=[];for(var i=h.length-1;i>=0;i--){var l=h[i];if(l.isOptionalParameter==="true"){h.splice(i,1);k.splice(0,0,l);}}for(var y=0;y<k.length;y++){k[y].visible=(k[y].selectedValue)?false:true;}return{Fields:h,AdvancedFields:k};});}function f(o){return g(o).then(function(e){return new sap.ui.model.json.JSONModel($.extend({view:'searchFields',expandAdvanced:false,selectedFieldValues:{},textSearchFieldValue:{},},o||{},e));});}function s(p){var B;p.done(function(){if(B!=null){B.close();}});p.fail(function(e,j){B&&B.close();var h=$.sap.getObject('responseJSON.error.message.value',true,j)||r.getText('COMMON_AJAX_DEFAULT_ERROR');M.error(h,{icon:sap.m.MessageBox.Icon.ERROR});});setTimeout(function(){if(p.state()=='pending'){$.sap.require('sap.m.BusyDialog');B=new sap.m.BusyDialog();B.open();}},100);}S.register("GACESearchField",{search:function(C){return c(C,0);}});S.register("GACEAdvancedSearch",{search:function(C){return d(C,0);}});var G={show:function(o){return new Promise(function(h,i){var m=f(o);s(m);m.then(function(j){try{var C=sap.ui.controller('sap.sf.surj.shell.mvc.GACEAdvancedSearch');var k=new sap.m.Dialog({contentWidth:'85%',contentHeight:'500px',resizable:true,draggable:true,models:j,title:r.getText('COMMON_Find_Employee'),verticalScrolling:true,afterOpen:function(){h(k);},afterClose:function(){k.destroy();},customHeader:new sap.m.Bar({contentLeft:new sap.m.Button({icon:'sap-icon://nav-back',tooltip:r.getText('COMMON_Back'),visible:{parts:[{path:'/view'}],formatter:function(v){return v!=='searchFields';}},press:[C.back,C]}),contentMiddle:new sap.m.Text({text:r.getText('COMMON_Find_Employee')})}),content:sap.ui.view({type:'JS',height:'100%',controller:C,viewName:'sap.sf.surj.shell.mvc.GACEAdvancedSearch'})}).removeStyleClass('sapUiPopupWithPadding').addStyleClass('surjAdvSearchDialog').open();}catch(e){$.sap.log.error('Exception creating dialog',e);i(e);}});});},createAdvancedSearchPromise:d,getModel:f};$.sap.setObject('sap.sf.surj.shell.util.GACEAdvancedSearchUtil',G);return G;});
