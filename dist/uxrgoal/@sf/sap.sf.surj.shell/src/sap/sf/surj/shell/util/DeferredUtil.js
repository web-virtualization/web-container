sap.ui.define('sap/sf/surj/shell/util/DeferredUtil',['jquery.sap.global','sap/sf/surj/shell/util/Util','sap/sf/surj/shell/util/Logger','sap/sf/surj/shell/util/SMRF','sap/sf/surj/shell/core/BizXResourceBundle','./ServiceVisibilityMapping'],function($,U,L,S,B,a){var M=window.MSGS;if(!M){M={};window.MSGS=M;}var C='/ajax/remoting/call/plaincall/';var D='/xi'+C;var b=(function(){var e={};for(var V in a){var i=a[V];if(i instanceof Array){i.forEach(function(I){e[I]="/"+V+C;});}}return e;}());var R=M.COMMON_RAL_SYSTEM_EXCEPTION_CONVERTER_ERROR||'The sensitive private data on this page could not be displayed because there was a failure writing to the Read Access Log.';var c=M.COMMON_SECURITY_SCANNER_EXCEPTION_CONVERTER_ERROR||'This content was rejected by the Security Scan of User Inputs feature because it might contain malicious content. Please review your content for security risks, such as scripting, and try again.';var d='80A8BD291A8E635A37D57F13E5D1F423'+Math.floor(1E3*Math.random());var f=0;var T='ajaxService';var g='ODataService';var h={TYPE_AJAX_SERVICE:T,TYPE_ODATA:g,createDeferred:function(e){return this.invokeService(e);},invokeService:function(e){var i=null;switch(e.type){case T:return this.invokeAjaxService(e);case g:return this.invokeODataService(e);default:throw new Error('Invalid service type');}},invokeAjaxService:function(I){function N(e){if(e==null){return'null:null';}else switch(typeof e){case"boolean":return"boolean:"+e;case"number":return"number:"+e;case"string":return"string:"+encodeURIComponent(e);case"object":if(e instanceof String){return"String:"+encodeURIComponent(e);}else if(e instanceof Boolean){return"Boolean:"+e;}else if(e instanceof Number){return"Number:"+e;}else if(e instanceof Date){return"Date:"+e.getTime();}else{return O(e);}case"function":return'';default:throw new Error("invalid type passed to serialize");}}function O(e){if(e&&e.join){var q1=["Array:["];for(var i=0;i<e.length;i++){i!=0&&q1.push(",");q1.push(Q(e[i]));}q1.push("]");return q1.join("");}else if(e.nodeName&&e.nodeType){if(window.XMLSerializer){e=(new XMLSerializer).serializeToString(e);}else if(e.toXml){e=e.toXml();}else{e=e.innerHTML;}return"XML:"+encodeURIComponent(e);}else{var q1="";for(var r1 in e){var s1=e[r1];if(typeof s1!='function'){q1+=(q1&&",")+encodeURIComponent(r1)+":"+Q(s1);}}return"Object_Object:{"+q1+"}";}}function Q(e){var q1;var r1=b1.some(function(s1){if(s1.value===e){q1=s1;return true;}});if(r1){return'reference:'+q1.id;}else{var id='c0-e'+(i1++);if(e&&typeof e=='object'){b1.push({id:id,value:e});}h1.push(id+'='+N(e,true));return'reference:'+id;}}function V(e){var q1=e.split('\n');var r1=false;var s1=null;for(var i=0;i<q1.length;i++){var t1=q1[i].trim();if(t1=='<dd class="msg">'){s1={};r1=true;}else if(r1){var u1=/<strong>(.*)<\/strong>/.exec(t1);if(u1){s1.message=u1[1];}else if(t1=='<div>'){s1.detail='';}else if(t1=='</dd>'){break;}else if(t1!='</div>'&&s1.detail!=null){s1.detail+=t1.replace('<br />','\n');}}}return s1;}function W(){delete window[Z];delete window[_];}function X(q1){if(q1.indexOf('throw')==0){window[Z]=function(s1,t1,u1){W();a1.resolve(u1);};window[_]=function(s1,t1,u1){if(typeof s1=='object')u1=s1;W();a1.reject(u1.message,u1);};try{U.dangerouslyEvalScript(q1.replace(/^throw .*\r?\n/,'').replace('dwr.engine._remoteHandleCallback',Z).replace('dwr.engine._remoteHandleException',_).replace('dwr.engine._remoteHandleBatchException',_).replace('if (window.dwr)','if (true)'));}catch(e){a1.reject('Invalid Server Response',e);}}else{var r1=V(q1);if(r1){a1.reject(r1.message,r1);}else{a1.reject('Invalid Server Response',q1);}}}if(!h.isAjaxServiceAllowed()){return $.Deferred().reject('AjaxServices are not allowed on this page');}if((window.AjaxService!=null&&!window.AjaxService.override)&&!I.noASProxy&&U.findURLParam('noASProxy')!='true'&&h.isAjaxServiceAvailable(I)){return this.invokeAjaxServiceLegacy(I);}var Y='sfDeferredUtilCallback';var Z=Y+(J++);var _=Y+(J++);var a1=$.Deferred();var b1=[];var c1=I.arguments;var d1=I.async!==false;var e1=I.serviceName;var f1=e1+'Proxy';var g1=I.serviceMethod;var h1=[['callCount=1'],['page='+window.location.pathname+window.location.search],['httpSessionId='],['scriptSessionId='+d],['c0-scriptName='+f1],['c0-methodName='+g1],['c0-id=0']];var i1=0;if(c1){for(var i=0;i<c1.length;i++){h1.push('c0-param'+i+'='+N(c1[i]));}}h1.push('batchId='+f++);var j1=(b[e1]||D)+f1+'.'+g1+'.dwr';if(window.ajaxSecKey){j1+='?_s.crb='+window.ajaxSecKey;}var k1={};var l1='skipSeamFilterJsfPhase';var m1=document.getElementById(l1);if(m1&&m1.content=='true'){k1['X-'+l1]='true';}var n1=window.AjaxServiceMeta||{};var o1=window.AjaxService||{};var p1=n1.viewId||o1._viewid||window.location.pathname;if(!/\.xhtml$/.test(p1)){p1+=".xhtml";}k1.viewid=p1;$.ajax({url:U.ensureBaseDomain(j1),type:'POST',data:h1.join('\n'),contentType:'text/plain',dataType:'text',success:X,headers:k1,async:d1,error:function(e){a1.reject('Unable to connect',e);},xhrFields:{withCredentials:true,}});return a1.promise();},invokeAjaxServiceLegacy:function(e){return this.loadAjaxService(e).then(function(i){var I=e.serviceMethod;if(typeof i[I]=='function'){var N=$.Deferred();var O=e.arguments||[];var Q=[].slice.call(O).concat({callback:function(){N.resolve.apply(this,arguments);},errorHandler:function(W,X){X&&s.error('Error invoking AjaxServiceHandler',X);var Y=(X&&X.errorCode);if(Y=='RALSE'){W=R;}else if(Y=='SECURITYSCANNER'){W=c+' '+W;}N.reject(W,X);}});i[I].apply(i,Q);var V=N.promise();if(e.timeout>0){return h.addTimeout(V,e.timeout);}return V;}else{var W='[DeferredUtil] The ajaxService method '+I+' does not exist';s.error(W);return $.Deferred().reject(W);}});},getAjaxServiceProxyUrl:function(e){var i=e.module;return'ajaxservice:'+(i?i+'.':'')+e.serviceName+(e.legacy?'?legacy=true':'');},initAjaxService:function(){if(this.isAjaxServiceAllowed()&&!window.AjaxService&&window.Proxy){window.AjaxService=G;}else if(window.AjaxService&&AjaxService.setViewId&&window.AjaxServiceMeta){var e=AjaxServiceMeta.viewId;if(e&&(e!=AjaxService._viewid)){AjaxService.setViewId(e);}}},loadAjaxService:function(e){if(!this.isAjaxServiceAllowed()){var i='[DeferredUtil] AjaxServices are not allowed';s.error(i);return $.Deferred().reject(i);}h.initAjaxService();var I=e.serviceName;var N=null;if(window.AjaxService){N=AjaxService.getMBeanInstance(I);}if(!N){var O=this.getAjaxServiceProxyUrl(e);var Q=m[O];if(!Q){var V=$.Deferred();Q=m[O]=V.promise();var W;if(!window.AjaxService){W=S.loadPromise('/ui/ajaxservice/js/AjaxService.js');}else{W=Promise.resolve();}W.then(function(){return S.loadPromise(O);}).then(function(){N=AjaxService.getMBeanInstance(I);if(N){V.resolve(N);}else{var i='[DeferredUtil] Could not find ajaxService '+I;s.error(i);V.reject(i);}},function(X){var i='[DeferredUtil] Could not load ASProxy with URI '+O;s.error(i);V.reject(i);});}return Q;}else{return $.Deferred().resolve(N);}},isAjaxServiceAllowed:function(){return U.isRunningBaseDomain();},isODataServiceAllowed:function(){if(U.isRunningBaseDomain()||U.isBaseDomainCORSEnabled()){return true;}var e=window.pageHeaderJsonData;return e&&e.odataProxyUrl;},isServiceAllowed:function(e){switch(e.type){case T:return h.isAjaxServiceAllowed();case g:return h.isODataServiceAllowed();}return false;},isAjaxServiceAvailable:function(e){if(window.AjaxService){var i=AjaxService.getMBeanInstance(e.serviceName);if(!i){var I=S.normalizeUrl(h.getAjaxServiceProxyUrl(e));if(!I){return false;}var V=window.DEPS_VERSION_MAP;if(!V||!V[I]){return false;}}}return true;},invokeODataService:function(I){I=$.extend({baseUrl:k,strictValidation:true},I);var N=$.Deferred();var O=I.baseUrl;var Q=I.serviceName;var V=I.serviceGroup;if(!V&&I.useOptimizedMetadata!==false){var W=A[O];for(var i=0;W&&i<W.length;i++){var X=W[i];if(h.isODataServiceRegistered(O,Q,X)){V=X;break;}}}if(I.useOptimizedMetadata==null){I.useOptimizedMetadata=!!(V||l[t(O,V)]);}function Y(){var _={};var a1=I.urlParams;if(a1&&typeof a1=='object'){if($.isArray(a1.results)){I.urlParams.results.forEach(function(e){_[e.key]=e.value;});}else{_=$.extend({},a1);}}_['$format']='json';var b1;if(I.action=="batch"){b1=O+'$batch';}else{b1=O+Q;}var c1=I.servicePath;if(c1){b1+=c1;}b1=h.processODataURL(b1+'?'+$.param(_));var d1={};var e1={headers:d1,xhrFields:{withCredentials:true}};if(I.headers){$.extend(d1,I.headers);}if(!I.strictValidation){d1['X-UI5-Strict-Validation']='false';}if(I.bustCache!==false){e1.cache=false;}var f1=I.method;if(f1){e1.method=f1;if(f1=='POST'){var g1=I.data;if(g1){if(typeof g1=='object'){g1=JSON.stringify(g1);}e1.data=g1;}e1.contentType='application/json';}}var h1;if(I.action=="upsert"){h1=$.ajax($.extend(e1,{method:'POST',url:b1,data:JSON.stringify(I.data),contentType:'application/json',dataType:'json'}));}else if(I.action=="delete"){h1=$.ajax($.extend(e1,{method:'DELETE',url:b1,dataType:'json'}));}else if(I.action=="batch"){h1=$.ajax($.extend(e1,{method:'POST',url:b1,headers:I.headers,data:I.data}));}else{h1=$.ajax($.extend(e1,{url:b1,dataType:'json'}));}h1.done(function(g1){N.resolve(g1&&g1.d?g1.d:g1);});h1.fail(function(i1,j1,k1){var l1='OData Service '+Q+' Failed, Error Status: '+j1;if(typeof k1=='string'){l1+=', errorThrown: '+k1;}s.error(l1);N.reject(l1,i1);var m1='COE0045';var n1='COE0059';var o1='COE0060';var p1=i1.getResponseHeader('Error-Code')||i1.getResponseHeader('X-Error-Code');switch(p1){case m1:h.showErrorDialog(R);break;case n1:h.showErrorDialog(c);break;case o1:try{var rb=sap.ui.getCore().getLibraryResourceBundle('sap.sf.surj.shell.i18n');var r1=i1.getResponseHeader('X-Message-Code');var s1='There was an error processing your request. Please contact support. Error Code: {0}';if(rb){s1=rb.getText('COMMON_WAF_BLOCK_EXCEPTION_CONVERTER_ERROR',r1);}h.showErrorDialog();}catch(e){s.error("Error loading resource bundle: "+e);}break;}});}if(I.useOptimizedMetadata){v(O,V).done(function(e){if(h.isODataServiceRegistered(O,Q,V)){O=e;}Y();});}else{Y();}var Z=N.promise();if(I.timeout>0){return this.addTimeout(Z,I.timeout);}return Z;},encodeStringForOData:function(e){if(e===null||typeof e==='undefined'){return"''";}else if(e==="''"){return e;}e=''+e;var i=e.length-1;if(e.length>2&&e.charAt(0)==="'"&&e.charAt(i)==="'"){e=e.substr(0,i);e=e.substr(1);}return"'"+e.replace(/\'+/g,"''")+"'";},normalizeODataResponse:function(e,i){if(e&&typeof e=='object'){for(var I in e){var V=e[I];var N=V&&V.results;if(N){if(N.length>0&&N[0].key){e[I]=N.reduce(function(O,Q){O[Q.key]=h.normalizeODataResponse(Q.value);return O;},{});}else{e[I]=N.map(h.normalizeODataResponse);}}else if(V&&typeof V=='object'){h.normalizeODataResponse(V,i);}}if(i&&e[i]){e=e[i];}}return e;},showErrorDialog:function(e){sap.ui.require(['sap/m/Text','sap/m/Dialog','sap/m/Button'],function(i,I,N){var O=[new i({text:e}).addStyleClass('exceptionText')];var Q=sap.ui.getCore().getLibraryResourceBundle('sap.sf.surj.shell.i18n');var V=new I('ajaxErrorDialog',{title:Q.getText('COMMON_Error'),contentWidth:'600px',resizable:false,content:O,endButton:new N({text:Q.getText('COMMON_Ok'),type:'Emphasized',press:function(W){W.getSource().getParent().close();}.bind(this)}),afterClose:function(){this.destroy();}}).addStyleClass('globalAjaxErrDialog');V.open();});},processODataURL:function(e){var i=window.pageHeaderJsonData||{};var I=i.odataProxyUrl;if(I){if(e&&e.indexOf('/')==0&&e.indexOf('//')!=0){if(I.lastIndexOf('/')==(I.length-1)){I=I.substring(0,I.length-1);}return I+e;}}else{return U.ensureBaseDomain(e);}return e;},createODataModel:function(e){e=$.extend({baseUrl:k,highPriority:false,version:1,options:{loadMetadataAsync:true,tokenHandling:false,json:true}},e||{});var i=e.baseUrl;var I=e.serviceGroup;if(e.useOptimizedMetadata==null){e.useOptimizedMetadata=!!(I||l[t(i,I)]);}function N(){var Q={1:'sap.ui.model.odata.ODataModel',2:'sap.ui.model.odata.v2.ODataModel',4:'sap.ui.model.odata.v4.ODataModel'};var V=$.extend({},e.options);var W=window.ajaxSecKey;if(typeof W=='string'){V.headers=V.headers||{};V.headers['X-CSRF-Token']=W;}var X=Q[e.version];if(X){$.sap.require(X);var Y=$.sap.getObject(X);return new Y(h.processODataURL(i),V);}else{throw'Invalid ODataModel version: '+e.version;}}function O(){if(e.useOptimizedMetadata===false){return N();}else{return v(i,I).then(function(Q){i=Q;return N();});}}if(e.highPriority){return O();}else{return this.whenLowPriority(e.priority).then(O);}},isODataServiceRegistered:function(e,i,I){var N=u(e,I);var O=N&&N.services;return O&&$.inArray(i,O)>=0;},registerODataServiceAlias:function(e){var i=arguments;if(i.length==3){e={baseUrl:i[0]||k,serviceGroup:i[1],serviceAlias:i[2]}}else{e=$.extend({baseUrl:k},e||{});}var I=u(e.baseUrl,e.serviceGroup||e.serviceAlias);I.serviceAlias=e.serviceAlias;I.optimizedBaseUrl=null;},registerODataService:function(e){e=$.extend({baseUrl:k},e||{});var I=e.baseUrl;var N=e.serviceAlias;var O=e.serviceGroup||N;var Q=u(I,O);var V=A[I]=A[I]||[];if($.inArray(O,V)<0){V.push(O);}if(N){Q.serviceAlias=N;}var W=!Q.optimizedBaseUrl;if(W){var X=e.serviceName;var Y=Q.services=Q.services||[];var Z=true;if(!$.isArray(X)){X=[X];}$.each(X,function(i,X){if($.inArray(X,Y)<0){Y.push(X);}});}else{s.error('The following service was already finalized: '+e.baseUrl+e.serviceName);}return W;},finalizeODataRegistry:function(e){var i,I,N;if(typeof e=='string'){i=e;I=arguments[1];N=arguments[2];}else if(e&&typeof e=='object'){i=e.baseUrl;I=e.serviceGroup;N=e.serviceAlias;}if(N&&!I){I=N;}u(i||k,I).finalize();},resetODataRegistry:function(e,i){l[t(e,i)]=null;},invokeJsonpService:function(e,i){var I='sfDeferredUtilCallback'+(J++);var Q=e.indexOf('?');var N=e.lastIndexOf('?');var O=/^(.*[&\?][^\?]+=)\?([^\?]*)$/.exec(e);if(N!==Q&&O){e=O[1]+I+O[2];}else{e+=((Q<0)?'?':'&')+'callback='+I;}var V=$.Deferred();window[I]=function(){if(V.state()=='pending'){V.resolve.apply(V,arguments);}};var W=document.createElement('script');W.id=I;W.type='text/javascript';W.src=e;var X=U.getCSPScriptNonce();if(X){W.nonce=X;}var Y=null;if(i!=null&&i>0){var Y=setTimeout(function(){if(V.state()=='pending'){V.reject('timeout');window[I]=function(){};}},i);}$(W).bind('error',function(){V.reject('unknown_error');});V.always(function(){$('#'+I).remove();Y!=null&&clearTimeout(Y);window[I]=null;});$('head')[0].appendChild(W);return V.promise();},addPriorityDeferred:function(I,N,O){if(O!==false){K++;}P++;I.always(function(){if(O!==false){--K;setTimeout(function(){if(K==0){n.resolve();}},20);}if(--P==0){var Q=0;$.each(o,function(i,e){Q+=p[e].length;});if(Q>0){s.debug('Priority Call '+N+' complete; now initiating '+Q+' low priority calls');$.each(o,function(i,V){var W=p[V];if(W.length>0){p[V]=[];$.each(W,function(i,X){if(typeof X=='function'){try{var I=X();if(I&&typeof I.promise=='function'){q.push(I);}}catch(e){s.error('A low priority call failed',e);}}});}});}else{s.debug('Priority Call '+N+' complete; no low priority calls waiting');}}});},whenKeyContentLoaded:function(){return n.promise();},whenLowPriority:function(e){var i=$.Deferred();this.delayLowPriorityCall(function(){i.resolve();},e);return i.promise();},delayLowPriorityCall:function(e,i){if(P==0){var I=e();if(I&&typeof I.promise=='function'){q.push(I);}}else{if(!p[i]){i='MEDIUM';}p[i].push(e);}},whenLowPriorityCallsFinish:function(){var e=$.Deferred();this.whenLowPriority().always(function(){setTimeout(function(){var i=q.length;function I(){if(i===q.length){e.resolve();}else{h.whenLowPriorityCallsFinish().then(function(){e.resolve();},function(){e.reject();});}}if(i>0){return $.when.apply($,q).then(I);}else{setTimeout(I,10);}},10);});return e.promise();},addTimeout:function(e,i){var I=$.Deferred();var N=setTimeout(function(){I.reject('timeout');},i);function O(Q,V){if(I.state()=='pending'){I[Q].apply(I,V);}if(I.state()!='pending'){clearTimeout(N);}}e.done(function(){O('resolve',arguments);}).fail(function(){O('reject',arguments);}).progress(function(){O('notify',arguments);});return I.promise();},whenUI5LibraryCSSReady:function(i){if(!r){var e='surjMLibTester';var I='sapMBarRight';var N='position';var O='absolute';var Q=5000;var V=50;var W=1000;var X=new Date().getTime();function Y(){var a1=$('#'+e);if(a1.length==0){a1=$('<div style="display:none"></div>').attr({id:e,class:I}).appendTo('body');}return a1.css(N)===O;};var Z=$.Deferred().always(function(){$('#'+e).remove();});if(Y()){Z.resolve();}else{function _(){if(Y()){Z.resolve();}else{var a1=new Date().getTime()-X;var b1=a1<=Q?V:W;setTimeout(_,b1);}};setTimeout(_,V);}r=Z.promise();}if(i>0){return this.addTimeout(r,i);}else{return r;}}};var J=0;function j(e,i){var Q=e.indexOf('?');var I=e.lastIndexOf('?');var N=/^(.*[&\?][^\?]+=)\?([^\?])*$/.exec(e);if(I!==Q&&N){e=N[1]+i+N[2];}else{e+=((Q<0)?'?':'&')+'callback='+i;}return e;}var k='/odata/v2/restricted/';var l={};var A={};var m={};var P=0;var K=0;var n=$.Deferred();var o=['HIGHEST','HIGH','MEDIUM','LOW','LOWEST'];var p={HIGHEST:[],HIGH:[],MEDIUM:[],LOW:[],LOWEST:[]};var q=[];var r;var s=L.getLogger('DeferredUtil');function t(e,i){return e+(i?'|'+i:'');}function u(e,i){var I=t(e,i);var N=l[I];if(!N){var O=$.Deferred();N=l[I]={finalizePromise:O.promise(),finalize:function(){O.resolve();}};}return N;}function v(e,i){var I=u(e,i);return I.finalizePromise.then(function(){var O=I.optimizedBaseUrl;if(O){return $.Deferred().resolve(O);}else{O=e;var N=I.serviceAlias;if(N){if(!/\/$/.test(O)){O+='/';}O+=N+'/';}else{var Q=I.services;if(Q&&Q.length>0){Q.sort();if(!/\/$/.test(O)){O+='/';}O+=Q.join(',')+'/';}}I.optimizedBaseUrl=O;}return O;});}var H=0;var w=[];var x=[];function y(i){i.forEach(function(I){try{typeof I=='function'&&I();}catch(e){jQuery.sap.log.error('Error on AjaxService hook callback');}});}function z(e,i){var I=H++;e.push({id:I,prehook:i});return I;}function E(e,I){for(var i=e.length-1;i>=0;i--){if(e[i].id==I){e.splice(i,1);}}}function F(e){e.length=0;}var G={override:true,getRedirectUrl:function(){return window.timeout_redirect_url;},getMBeanInstance:function(e){return new Proxy({},{get:function(i,I){return function(){y(w);var N=Array.prototype.slice.call(arguments);var O=N[N.length-1];var Q={};var V;if(typeof O!='undefined'){if(typeof O=='function'){Q.callback=O;}else{Q=O;}V=O.async;}N.splice(N.length-1,1);h.invokeAjaxService({noASProxy:true,async:V,serviceName:e,serviceMethod:I,arguments:N}).done(function(W){if(typeof Q.callback=='function'){Q.callback(W);}y(x);}).fail(function(W){jQuery.sap.log.error(W);if(typeof Q.errorHandler=='function'){Q.errorHandler(W);}});}}});},addPreHook:function(e){return z(w,e);},removePreHook:function(i){E(w,i);},clearPreHooks:function(){F(w);},addPostHook:function(e){return z(x,e);},removePostHook:function(i){E(x,i);},clearPostHooks:function(){F(x);}};(function(){var e=$.Deferred();h.addPriorityDeferred(e.promise(),'init.ui5');sap.ui.getCore().attachInit(function(){e.resolve();});})();(function(e){if(e){var i=$.Deferred();h.addPriorityDeferred(i,'PerfPhase.highPriority');window.PerfPhase.runLowPriority(function(){i.resolve();});}})(window.PerfPhase);$.sap.setObject('sap.sf.surj.shell.util.DeferredUtil',h);return h;});
