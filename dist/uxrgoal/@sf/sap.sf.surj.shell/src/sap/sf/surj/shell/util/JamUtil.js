sap.ui.define('sap/sf/surj/shell/util/JamUtil',['jquery.sap.global','sap/sf/surj/shell/util/Logger','sap/sf/surj/shell/util/SearchUtil','sap/sf/surj/shell/util/LinkUtil','sap/sf/surj/shell/util/DeferredUtil','sap/sf/surj/shell/util/Util'],function($,L,S,a,D,U){var P=60000;var b='jamSimulation.jsp';var I='/inbox/view';var B='/externalapi/layout/rest/v0/jam/fetch_updates/unread_notifications';var J='/fetch_updates/unread_notifications';var c='/search/universal_search2';var d='/search/universal_search_autocomplete';var e='items=inbox&jsonp=?';var C=null;var f=L.getLogger('JamUtil');function g(o){return n(j.getBaseUrl(),d,$.param({output:'json',results:10,group_id:o.groupId||'0',query:o.searchValue}));}function h(o){return n(j.getBaseUrl(),c,$.param({group_id:o.groupId||'0',query:o.searchValue}));}var i={search:function(o){return $.ajax({url:g(o)}).then(function(R){var q=R&&R.ResultSet&&R.ResultSet.Results;return{type:'Jam',items:q||[],hasMore:false,totalCount:q&&q.length};},function(){return MSGS.COMMON_AJAX_DEFAULT_ERROR});},getExternalSearchUrl:function(o){return h(o);},selectItem:function(o){var q=o.item;a.gotoURL(q.Href);}};S.register('Jam',i);S.register('JamGroup',i);var j={getBaseUrl:function(){return k('/jamBaseUrl');},getSFBaseUrl:function(){return k('/baseUrl');},getGotoURL:function(){return n(j.getBaseUrl(),I);},isEnabled:function(){var o=j.getBaseUrl();return!!(o&&typeof o=='string');},isBizXUpdateDisabled:function(){return true;},isBizXBackupSupported:function(){return j.isBizXLocation();},isBizXLocation:function(){return U.isRunningBaseDomain();},getCurrentGroup:function(){var o=window.jamApp;return(o&&!o.inHomePage&&o.currentGroup)||null;},getDefaultGroupId:function(){var G=this.getCurrentGroup();return G&&typeof G.toParam=='function'&&G.toParam();},getDefaultGroupLabel:function(){var o=this.getCurrentGroup();return o&&typeof o.get=='function'&&o.get('name');},_delayPromise:l,_createJamAutoCompleteUrl:g,_createJamActionUrl:h,_search:i.search,_getExternalSearchUrl:i.getExternalSearchUrl,_selectItem:i.selectItem,_pageHeaderAvailable:p,getNotificationCount:function(){if(C){return C;}return C=j._delayPromise(p()).then(function(){if(j.isEnabled()){return s();}else{return $.Deferred().reject('Jam is not enabled in your company');}});},};function s(){var o=$.Deferred();var q=j.isBizXBackupSupported();var t=null;var u=null;var F=0;var v=0;function x(y){var z=F>0&&q;var M=sap.ui.getCore().getModel('pageHeader');if(m()){y=true;}if(z){v++;var A=j.isBizXUpdateDisabled();M.setProperty('/bizxUpdateDisabled',A);if(v>1){if(A){y=true;}}}if(y){var R=new Date().getTime()-u;setTimeout($.proxy(x,null,false),Math.max(0,P-R));}else{u=new Date().getTime();r(z).done(function(E){M.setProperty('/failedJamSessionCheck',false);if(t!==E){t=E;o.notify(E);}x(true);}).fail(function(E){F++;var G=z?'bizx':'jam';f.error('Possible '+G+' failure, statusCode returned as '+E+(z||!q?'':' will attempt a BizX call as backup.'));var H=(E==401||E==403);M.setProperty('/failedJamSessionCheck',H);if(z){o.reject(E);}else{x(!q);}});}}x(false);return o.promise();}function r(u){var o,q;if(u){o=j.getSFBaseUrl();q=B;}else{o=j.getBaseUrl();q=J;}var t=D.invokeJsonpService(n(o,q,e));return t.then(function(v,E){if(u&&window.SFSessionTimeout&&typeof SFSessionTimeout.reset=='function'){SFSessionTimeout.reset();}if(v==null&&E&&typeof E=='object'){return $.Deferred().reject(E.statusCode);}else if(v==null){return $.Deferred().reject('unknown_error');}else{var x=null;if(v!=null){x=parseInt(v,10);if(isNaN(x)){var y=v.notifications_count;if(!isNaN(y)){x=y;}else{x=v.total;}}}return(parseInt(x,10)>0)?x:0;}});}function p(){return w(function(){return sap.ui.getCore().getModel('pageHeader');},10);}function k(o){var M=sap.ui.getCore().getModel('pageHeader');return M&&M.getProperty(o);}function w(o,q){var t=$.Deferred();if(o()){t.resolve();}else{function u(){setTimeout(function(){if(o()){t.resolve();}else{u();}},q);};u();}return t.promise();}function l(o){var q=$.Deferred();var R=$.Deferred();o.done(function(){var t=arguments;R.done(function(){q.resolve.apply(q,t);});}).fail(function(){var t=arguments;R.done(function(){q.reject.apply(q,t);});}).progress(function(){var t=arguments;R.done(function(){q.progress.apply(q,t);});});setTimeout(function(){R.resolve();},1);return q.promise();}function m(){var o=document;return o.hidden||o.webkitHidden||o.mozHidden||o.msHidden;}function n(o,q,Q){var R=o,t,u;if(!R){R=q;}else if(q){t=R.indexOf('?');if(t<0){t=R.length;}u=R.lastIndexOf(';',t);if(u>=0){t=u;}var v=R.substring(t);if(o.indexOf(b)>=0){R=R.substring(0,t)+'?path='+encodeURIComponent(q);if(v){R+=v.substring(1);}}else{R=R.substring(0,t)+q+v;}}if(Q){if(R){R+=(R.indexOf('?')>=0)?'&':'?';}else{R='?';}R+=Q;}return R;}$.sap.setObject('sap.sf.surj.shell.util.JamUtil',j);return j;});
