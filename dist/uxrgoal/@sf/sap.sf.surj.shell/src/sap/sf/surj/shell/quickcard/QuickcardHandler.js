sap.ui.define('sap/sf/surj/shell/quickcard/QuickcardHandler',['jquery.sap.global','sap/sf/surj/shell/util/Logger','sap/sf/surj/shell/util/SMRF','sap/sf/surj/shell/util/Util'],function($,L,S,U){var a=500;var b=L.getLogger('QuickcardHandler');var Q=function(){var A;var h=[];var s=this;$.extend(s,{showQuickcardForSuggestion:function(C){b.info('Quickcard requested',C);var e=false;var t=this;var i=d(C);return $.extend(i.then(function(){return $.when(t.getOrCreateQuickcard(C)).done(function(q){if(q!==A){t.hideActiveQuickcard();if(q){var o=C.origin||C.suggestionItem.$()[0];A=q;q.show(o,false,C.refocusId);}}}).fail(function(k){b.error.apply(b,arguments);});},function(){b.info('Quickcard request was canceled');}),{cancel:$.proxy(i.cancel,i),config:C});},getOrCreateQuickcard:function(C){switch(C.type){case'People':return f(C);}return $.Deferred().resolve();},focusQuickcard:function(){if(A&&A.isRegistered()){A.setFocus();var t=this;this.addQuickcardHiddenCallback(this._removeKeyListeners=this._removeKeyListeners||function(){$(window).off(t._keyListeners);t.removeQuickcardHiddenCallback(t._removeKeyListeners);});$(window).on(this._keyListeners=this._keyListeners||{keydown:function(e){if(e.keyCode==$.sap.KeyCodes.ESCAPE){setTimeout(function(){t.hideActiveQuickcard(true);},0);}}});}},hideActiveQuickcard:function(e){if(A&&A.isRegistered()){A.hide(e);}},addQuickcardHiddenCallback:function(H){if($.inArray(H,h)<0){h.push(H);}},removeQuickcardHiddenCallback:function(H){var i=$.inArray(H,h);if(i>=0){h.splice(i,1);}}});var c=null;function d(C){var D=$.Deferred();var e=true;var i;c&&c();c=function(){c=null;e=false;D.reject();};var k=new Date().getTime();var m=C.type=='Person'||C.type=='People'?l():$.Deferred().resolve();m.then(function(){if(e){c=null;var n=C.immediate?0:a;var o=new Date().getTime()-k;var r=n-o;if(r<=0){D.resolve();}else{var t=window.setTimeout(function(){c=null;D.resolve();},r);c=i=function(){window.clearTimeout(t);D.reject();}}}},function(r){$.sap.log.error('Could not load Quickcard',r);});return $.extend(D.promise(),{cancel:function(){i&&i();}});}var P={};function g(C){var p=C.item;return p.userId+','+p.personId+','+C.itemIndex+','+C.fromHeader;}function f(C){var k=h;var p=C.item;var K=g(C);var F=null;if(window.Quickcard){F=window.Quickcard.newInstance;}else{var m=$.sap.getObject('sap.sf.quickcard.QuickcardInternal');if(!m){return $.Deferred().reject('QuickcardInternal not available');}F=function(C){return new m(C);}}try{oQuickcard=F({personId:p.personId,userId:p.userId,itemIndex:C.itemIndex,fromHeader:C.fromHeader,a11yAnnouncements:C.a11yAnnouncements,personInfoModel:P[K]});}catch(e){return $.Deferred().reject(e);}oQuickcard.addEventListener('hide',{handleEvent:function(){$.each(k,function(i,n){if(typeof n=='function'){n();}});}});$.when(oQuickcard.getDAO()).done(function(i){i.addEventListener('personInfoAvailable',{handleEvent:function(n){P[K]=n;}});});return oQuickcard;}var j;function l(){if(window.Quickcard){return Promise.resolve();}else if(!j){var p;var m=document.getElementById('ui5QC');if(m&&m.getAttribute('content')=="true"){p=sap.ui.resource('sap.sf.quickcard','library-preload.js');var e=sap.ui.resource('sap.sf.surj.preload.resources','header-aux-bundle.js');return Promise.all([U.dangerouslyIncludeScript(e),U.dangerouslyIncludeScript(p)]).then(function(){return sap.ui.getCore().loadLibrary('sap.sf.quickcard',{async:true}).then(function(){return new Promise(function(r,i){sap.ui.require(['sap/sf/quickcard/QuickcardInternal'],r,i);});});});}else{j=S.loadPromise(['/ui/quickcard/js/quickcard.js']).catch(function(r){$.sap.log.error('SMRF could not load quickcard dependency: '+r);p=sap.ui.resource('sap.sf.quickcard','library-preload.js');U.dangerouslyIncludeScript(p).then(function(){return sap.ui.getCore().loadLibrary('sap.sf.quickcard',{async:true}).then(function(){return new Promise(function(i,k){sap.ui.require(['sap/sf/quickcard/QuickcardInternal'],i,k);});});});});}}return j;}};$.sap.setObject('sap.sf.surj.shell.quickcard.QuickcardHandler',Q);return Q;});
