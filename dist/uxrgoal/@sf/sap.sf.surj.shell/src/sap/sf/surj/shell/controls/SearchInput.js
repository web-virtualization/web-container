jQuery.sap.declare("sap.sf.surj.shell.controls.SearchInput");jQuery.sap.require("sap.sf.surj.shell.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.sf.surj.shell.controls.SearchInput",{metadata:{library:"sap.sf.surj.shell"}});sap.ui.define('sap/sf/surj/shell/controls/SearchInput',['jquery.sap.global','sap/m/Input','sap/m/Popover','sap/m/PlacementType','sap/m/ColumnListItem','sap/m/Column','sap/sf/surj/shell/controls/SearchResult','sap/sf/surj/shell/controls/GACESearchResult','sap/sf/surj/shell/util/SearchUtil','sap/sf/surj/shell/util/A11yPreferences','./SearchInputRenderer','sap/sf/surj/shell/util/GACESearchUtil'],function($,I,P,a,C,b,S,G,c,A,d,e){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle('sap.sf.surj.shell.i18n');var p;return I.extend('sap.sf.surj.shell.controls.SearchInput',{metadata:{properties:{settings:'object',searchType:{type:'string',defaultValue:'jsup'},scrollThreshold:{type:'int',defaultValue:20},alwaysBottom:{type:'boolean',defaultValue:false},showButton:{type:'boolean',defaultValue:false},pending:{type:'boolean',defaultValue:false},objectValue:'any',forceItemSelection:{type:'boolean',defaultValue:false}},renderer:d,library:'sap.sf.surj.shell',events:{itemSelected:{parameters:{selectedItem:{type:"any"}}},itemChange:{}},aggregations:{_buttonLabelText:{type:"sap.ui.core.InvisibleText",multiple:false,visibility:"hidden"}}},constructor:function(i,o){if(typeof i=='object'){o=i;i=undefined;}var m=this;var s=this._getBaseSettings(o);this._oThrottle=c.createThrottle();this._oThrottle.attachEvent('pageReady',$.proxy(this._onPageReady,this));this._oThrottle.attachEvent('pending',$.proxy(this._onPending,this));if(typeof i=='string'){I.call(this,i,s);}else{I.call(this,s);}},ontap:function(E){var f=this.getRenderer().CSS_CLASS_COMBOBOXBASE,o=E.srcControl;if(!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(o.isOpenArea&&o.isOpenArea(E.target)){if(this.isOpen()){this.close();this.removeStyleClass(f+"Pressed");return;}this.open();}else{var s=I.prototype.ontap;s&&s.apply(this,arguments);}if(this.isOpen()){this.addStyleClass(f+"Pressed");}},ontouchstart:function(E){if(!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(this.isOpenArea(E.target)){this.bOpenedByButton=true;this.addStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed");}else{var s=I.prototype.ontouchstart;s&&s.apply(this,arguments);}},ontouchend:function(E){if(!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(!this.isOpen()&&this.isOpenArea(E.target)){this.removeStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed");}},onsapshow:function(E){if(!this.getShowButton()||!this.getEnabled()||!this.getEditable()){return;}E.setMarked();if(E.keyCode===jQuery.sap.KeyCodes.F4){E.preventDefault();}if(this.isOpen()){this.close();return;}this.bOpenedByButton=true;this.open();},getStartSuggestion:function(){if(this.bOpenedByButton){return 0;}return I.prototype.getStartSuggestion.call(this);},open:function(){this.focus();this._onSuggest("");},focus:function(){I.prototype.focus.call(this);if(this.isOpen()&&window.getSelection){window.getSelection().removeAllRanges();}},close:function(){this._closeSuggestionPopup();},_onPopoverOpening:function(){},_onPopoverClosed:function(E){this.bOpenedByButton=false;},isOpen:function(){var o=this._oSuggestionPopup;return o&&o.isOpen();},isOpenArea:function(D){var o=this.getOpenArea();return o&&o.contains(D);},getOpenArea:function(){return this.getDomRef("arrow");},_getBaseSettings:function(o){return $.extend({},o,{autocomplete:false,filterSuggests:false,showSuggestion:true,showTableSuggestionValueHelp:false,suggestionColumns:this._getSuggestionColumns(),suggestionItemSelected:$.proxy(this._onSuggestionItemSelected,this),suggest:$.proxy(this._onSuggest,this),change:$.proxy(this._onChange,this)});},_onChange:function(E){this.fireItemChange();},_onSuggestionItemSelected:function(E){var R=E.getParameter('selectedRow').__oResultItem;var D=this._getDisplayText(R,true);this._oThrottle.abort();this.setValue(D||'');if(R){this.setProperty("objectValue",R,true);this.fireItemSelected({selectedItem:R});}},_onSuggest:function(E){this.removeAllSuggestionRows();this._initSuggestionPopup();var q=typeof E=='string'?E:E.getParameter('suggestValue');if(q.length>=this.getStartSuggestion()||E===""){this._doSearch(q);}},_onPageReady:function(E){var m=this;var o=E.getParameter('criteria');var q=o.searchValue||o.query;var f=E.getParameter('items');if(f&&f.length>0){$.each(f,function(i,R){var g=new C({cells:m._createSearchResult(R,q)}).addEventDelegate({onAfterRendering:function(h){jQuery("#"+h.srcControl.getId()).attr("role","menuitem");}}).addStyleClass(m._getListItemStyleClass(R));m.addSuggestionRow($.extend(g,{__oResultItem:R}));});this._checkScroll();}else{this.addSuggestionRow(new C({cells:$.extend(new S({text:r.getText('COMMON_No_Results')}),{__bNoResults:true})}));}},_onPending:function(E){this.setPending(E.getParameter('pending'));},setPending:function(f){this.setProperty('pending',f,true);this[f?'addStyleClass':'removeStyleClass']('bizXSFPending');},_doSearch:function(q){this._oThrottle.change(this.getSearchType(),this._createCriteria(q));},_createCriteria:function(q){var o;if(this.getSearchType()=='jsup'){o=$.extend({query:q},this.getSettings()||{});}else{o=$.extend({searchValue:q},this.getSettings()||{});}return o;},_checkScroll:function(){if(this.isOpen()){if(!this._oScrollDelegate){this._oScrollDelegate=this._oSuggestionPopup.getScrollDelegate();this._oScrollDelegate&&this._oScrollDelegate.setGrowingList($.proxy(this._checkScroll,this));}if(this._isScrolledBottom()&&this._oThrottle.hasMore()){this._oThrottle.more();}}else if(!this.bIsDestroyed){setTimeout($.proxy(this._checkScroll,this),10);}},_isScrolledBottom:function(){if(this._oScrollDelegate){var s=this._oScrollDelegate.getScrollTop();var m=this._oScrollDelegate.getMaxScrollTop();return m-s<this.getScrollThreshold();}return false;},_initSuggestionPopup:function(){if(!this._popupInit){var o=this._oSuggestionPopup;if(o&&this.getAlwaysBottom()){o._calcVertical=function(){P.prototype._calcVertical.call(this);this._oCalcedPos=a.Bottom;}}o.addStyleClass('surjliSuggest');o.addStyleClass('globalMenu');o.addStyleClass('globalContainerHoverSansFocus');o.attachBeforeOpen($.proxy(this._onPopoverOpening,this));o.attachAfterClose($.proxy(this._onPopoverClosed,this));this._popupInit=true;}},_createSearchResult:function(R,q){if(this._isGACESearchResultItem(R)){var s=this.getSettings();var f=(s&&s.additionalCriteria&&s.additionalCriteria.resultScope)||'EMPLOYMENT';var o;if(!R.subItem||R.firstSubItem){o=this._getPhotoSrc(R)}return new G({resultScope:f,personItem:R,settings:s}).setText(this._getDisplayText(R,false)).setPhotoSrc(o).setSearchValue(q);}else{var g=new S().setSearchValue(q).setText(this._getDisplayText(R,false)).setInfo(this._getDisplayInfo(R)).setSubtitle(this._getSubtitle(R));if(this._hasPhoto(R)){g.setPhotoSrc(this._getPhotoSrc(R));}return g;}},_getPhotoSrc:function(R){var o;if(R.legacyItem){R=R.legacyItem;}if(this._hasPhoto(R)){if(!R.photoViewable){if(!p){p=sap.ui.resource('sap.sf.surj.shell.img.userphoto','UserPhotoPlaceholder_50x50.png');}o=p;}else{o=R.photoUrl||R.photoSrc;}if(!o){var u=R.UserId||R.userId;var s=R.photoMod;o={userId:u,urlType:'eduPhoto',photoType:'face',mod:s};}}return o;},_getDisplayInfo:function(R){if(R.legacyItem){R=R.legacyItem;}if(this._isUserSearch()){if(this._isHideUserName()){var t=[];if(R.Location){t.push(R.Location);}if(R.Department){t.push(R.Department);}if(t.length>0){return t.join(', ');}}else{return R.userName||R.UserName;}}return null;},_getSubtitle:function(R){var s=R.keys&&R.keys.TITLE;return s===null?'':s;},_getDisplayText:function(R,i){var o=R;if(!R){return null;}var l=R.legacyItem;if(l){R=l;}if(this._isGACESearchResultItem(o)){var E=R.employments&&R.employments[0];var t=E&&E.title;if(R.hasEmploymentDifferentiatorText===true){return r.getText('COMMON_Person_AutoComplete_Title_And_Location',[R.name,E.employmentDifferentiatorText]);}if(t){return r.getText('COMMON_Person_AutoComplete_Title_And_Location',[R.name,t]);}if(i==true&&!R.name){return R.email;}return R.name;}else if(this._isUserSearch()){var f=R.FullName||R.fullName||R.name;if(!f){f=r.getText('COMMON_User_Display_Name',[R.firstName||R.FirstName,'',R.lastName||R.LastName]);}return f;}else{return R.name||R.actionLabel;}},_getListItemStyleClass:function(R){var f=['surjli'];var o=R;var l=R.legacyItem;if(l){R=l;}if(this._isGACESearchResultItem(o)){if(this._hasPhoto(R)){f.push('surjli-personEmployment');}f.push('surjli-personEmploymentGACE');if(R.subItem){f.push('surjli-subItem');}if(R.firstSubItem){f.push('surjli-firstSubItem');}else{f.push('surjli-nonFirstSubItem');}if(R.lastSubItem){f.push('surjli-lastSubItem');}else{f.push('surjli-nonLastSubItem');}}else if(this._getSubtitle(R)!=null){f.push('surjli-hasSubTitle');}if(this._hasPhoto(R)){f.push('surjli-hasphoto');}if(A.isLowVisionEnabled()){f.push('globalLowVisionSupport');f.push(A.getLowVisionType());}f.push('globalMenuItem');f.push('globalMenuItemBackground');return f.join(' ');},_hasPhoto:function(R){var s=$.sap.getObject('pageHeaderJsonData.settings');return this._isPersonResult(R)&&((s&&s['autocomplete.enablePhoto']=='true')||$('#autocomplete\\.enablePhoto').attr('content')=='true');},_isPersonResult:function(R){return R.UserId||R.userId||R.photoUrl||R.photoSrc;},_isHideUserName:function(){return $.sap.getObject('pageHeaderJsonData.settings')['autocomplete.hideUserName']=='true'||$('#autocomplete\\.hideUserName').attr('content')=='true';},_isUserSearch:function(){switch(this.getSearchType()){case'jsup':var s=this.getSettings();var f=(s&&s.findtype)||'fullname';return'firstname lastname username fullname proxy customUserSearch'.indexOf(f)>=0;case'Person-Employment-User':case'People':return true;}return false;},_isGACESearchResultItem:function(R){return this.getSearchType()=='Person-Employment-User'&&R.personBased;},_getSuggestionColumns:function(){return[new b()];},onBeforeRendering:function(){I.prototype.onBeforeRendering.apply(this,arguments);this._initArrowButton();},onfocusout:function(E){if(this.getForceItemSelection()){if(this._focusOutId==null){this._focusOutId=setTimeout(function(){this._focusOutId=null;this.setValue(this._getDisplayText(this.getObjectValue(),false));}.bind(this),0);}}var f=I.prototype.onfocusout;f&&f.apply(this,arguments);},onfocusin:function(E){var o=this.getOpenArea();var t=E.target;if(o==t||(o&&o.parentNode==t)){this.focus();}var f=I.prototype.onfocusin;f&&f.apply(this,arguments);},_initArrowButton:function(){var t=this;var i=this._arrowButton;if(!i&&this.getShowButton()){var R=sap.ui.getCore().getLibraryResourceBundle("sap.m");i=this._arrowButton=this.addEndIcon({id:this.getId()+"-arrow",src:"sap-icon://slim-arrow-down",noTabStop:true,alt:R.getText("COMBOBOX_BUTTON"),decorative:false,press:function(){if(t.getValue()){t._onSuggest('');}}});i.addAriaLabelledBy("");}if(i){i.setVisible(this.getShowButton());}},setShowButton:function(s){var o=this.setProperty("showButton",s,true);this._initArrowButton();return o;}});});
