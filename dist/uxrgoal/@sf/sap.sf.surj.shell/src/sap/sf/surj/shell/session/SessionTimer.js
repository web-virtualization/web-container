sap.ui.define(['jquery.sap.global','sap/ui/Device','sap/ui/base/EventProvider','sap/ui/model/json/JSONModel','../util/DeferredUtil','../util/LinkUtil','../util/Util','jquery.sap.storage'],function($,D,E,J,a,L,U){var S=$.sap.storage;var b='local';var c='BizXSessionTimer';var d=['click','keypress'];var M=60000,f=1000,g=10000;var h=100;var j=f;var k=10;var l=true;var B={type:'ajaxService',module:'v4',serviceName:'sessionTimeoutController',noASProxy:true};var m={CONFIG:{serviceMethod:'getSessionTimeoutConfigs'},KEEP_ALIVE:{serviceMethod:'keepAlive'},INVALIDATE:{serviceMethod:'invalidateSession'}};var _={};var n=new E();var o;var p;var q;var r;var s=new J({type:'alive'});function t(){p=false;q=false;}function u(){var e=o1._oInitPromise;if(!e){e=o1._oInitPromise=v().then(function(){o1._bHasStarted=true;$.sap.log.debug('BizXSessionTimer initialized');},function(i){if(typeof i=='object'){console.error(i);}else{$.sap.log.error('BizXSessionTimer failure: '+i);}x();return Promise.reject(i);});if(o1._fResolveStart){e.then(o1._fResolveStart,o1._fRejectStart);}}return e;}function w(){var e=o1._oInitPromise;if(!e){e=o1._oPendingStartPromise;if(!e){e=new Promise(function(i,p1){o1._fResolveStart=i;o1._fRejectStart=p1;});o1._oPendingStartPromise=e;}}return e;}function v(){t();o1._bDisableUI=!!o1._bDisableUI||U.isMessageServicePage();var i=U.isRunningBaseDomain();var e=i||U.isBaseDomainCORSEnabled();if(e){var p1=[a1().then(function(q1){o1._oSettings=q1;})];if(!i){p1.push(U.getMessageService().then(function(q1){o1._oMessageService=q1;}));}return Promise.all(p1).then(function(){P();if(i){y(S(b,c));}var q1=o1._oMessageService;if(q1){q1.sendMessage('BizXSessionTimer');q1.attachEvent('updateTimeoutEstimate',function(r1){var s1=r1.getParameter('data');var t1=s1&&s1[1];if(t1){F(t1);}});q1.attachEvent('logoutComplete',G);}else{C();}});}else{return Promise.reject('disabled');}}function x(){var i=o1._iPollId;if(i!=null){o1.clearInterval.call(null,i);o1._iPollId=null;}var e=o1._iTickId;if(e!=null){o1.clearTimeout.call(null,e);o1._iTickId=null;}var p1=o1._oMessageService;if(p1){p1.disconnect();o1._oMessageService=null;}T();o1._oInitPromise=o1._bHasStarted=null;}function y(e){if(e.isSupported()){o1._oStorage=e;o1._iPollId=o1.setInterval.call(null,function(){var i=z();if(i){var p1=e.get(i);var q1=o1._iTimeoutEstimate;if(p1=='logout'||typeof p1=='number'&&(q1==null||p1>q1)){F(p1);}else if(q1!=null){e.put(i,q1);}}},j);}}function z(){return U.getSessionRef();}function A(){if(o1._iTickId){clearTimeout(o1._iTickId);o1._iTickId=null;}var e=o1._oSettings;var i=new Date().getTime();var p1=false;if(o1._bConsiderActivity&&o1._iLastUserActivity){var q1=i-o1._iLastUserActivity;p1=q1<(e.timeUntilExpires*f);}var r1=o1._iTimeoutEstimate;var s1=r1=='logout';var t1=s1?'timeout':'alive';var u1,v1;if(!s1&&r1>0){var w1=r1-i;s1=w1<=0;if(!s1){var x1=e&&e.timeUntilWarning;if(x1>0){var y1=w1-(x1*M);var z1=y1>0&&y1<=g;if(z1){n.fireEvent('upcomingWarning');}var A1;if(y1<=0){if(p1){o1._iLastUserActivity=null;Z();return;}else{t1='warning';A1=w1>2*M?M:f;if(w1<M){v1=Math.round(w1/f);u1='s';}else{v1=Math.round(w1/M);u1='m';}}}else{t1='alive';A1=w1-x1*M;if(!z1){A1-=g;}}o1._iTickId=o1.setTimeout.call(null,A,A1);}}}if(p){t1='logout';}else if(s1){t1='timeout';}var B1={type:t1,countDown:v1,interval:u1,disableUI:o1._bDisableUI};var C1=JSON.stringify(B1);if(o1._sState!=C1){o1._sState=C1;n.fireEvent('stateChanged',B1);}}n.attachEvent('stateChanged',function(e){var i=e.getParameters();var p1=s.getProperty('/params');s.setProperty('/params',i);var q1=i.type;if(q1=='warning'&&(!p1||p1.type!='warning')){n.fireEvent('sessionAboutToExpire');}if(q1=='warning'){n.fireEvent('sessionWarning');}if(q1=='timeout'){n.fireEvent('sessionTimedOut');}});function C(){var e=o1._oSettings;if(e){var i=new Date().getTime()+(e.timeUntilExpires*f);var p1=o1._iTimeoutEstimate;if(typeof p1!='number'||Math.abs(p1-i)>h){F(i);if(o1._oMessageService){o1._oMessageService.sendMessage('updateTimeoutEstimate',i);}}n.fireEvent('sessionExtended');}}function F(i,e){if(i!=o1._iTimeoutEstimate){o1._iTimeoutEstimate=i;var p1=o1._oStorage;if(p1){p1.removeAll();var q1=z();q1&&p1.put(q1,i);}if(!e){var r1=o1._oMessageService;if(r1){r1.sendMessage('updateTimeoutEstimate',i);}else if(U.isMessageServicePage()){PostMessageAPI.sendMessage('updateTimeoutEstimate',i);}}n.fireEvent('timeoutEstimateChanged',{time:i});A();}}function G(){F('logout');}function H(){if(o1._bHasStarted){return Promise.resolve(G());}else{return w().then(function(){return G();});}}function I(){p=true;F('logout');}function K(){if(o1._bHasStarted){return Promise.resolve(I());}else{return w().then(function(){return I();});}}function N(i){F(new Date().getTime()+i);}function O(i){if(o1._bHasStarted){return Promise.resolve(N(i));}else{return w().then(function(){return N(i);});}}function P(){if(!q){q=true;Q(C);}}function Q(e){if(window.AjaxService){AjaxService.addPreHook(e);}$(document).ajaxSend(function(i,p1,q1){var r1=q1&&q1.url;if(r1){var s1=r1;if((r1.indexOf('/')==0&&r1.indexOf('//')!=0)||r1.indexOf("./")==0){s1=U.getLocationOrigin();}if(U.isBizXDomain(s1)&&/^(?:https?:\/\/[^\/]*|\/\/[^\/]*|)\/(sf|xi|odata)\/.*/.test(r1)){e();}}});}n.attachEvent('stateChanged',function(e){var i=e.getParameters();var p1=i.type;if(!i.disableUI){if(p1=='alive'||p1=='logout'){T();}else{R().then(function(q1){if(!o1._bDisableUI){q1.open();}});}}else{T();}});function R(){return r=r||new Promise(function(e){sap.ui.require(['sap/ui/model/resource/ResourceModel'],function(i){e(sap.ui.xmlfragment('sap.sf.surj.shell.session.SessionTimer',{formatTimerHTML:function(p1,q1){var r1='';var s1=j1();var t1=p1.type;if(t1=='timeout'){r1=s1.getText('COMMON_SESSION_EXPIRED_MESSAGE_DETAILS');if(q1){r1+='<br />';r1+=q1;}}else if(t1=='warning'){var u1=p1.countDown;r1=s1.getText('COMMON_SESSION_WARNING',[u1,s1.getText({s:['COMMON_SESSION_SECOND','COMMON_SESSION_SECONDS'],m:['COMMON_SESSION_MINUTE','COMMON_SESSION_MINUTES']}[p1.interval][u1==1?0:1])]);}return'<div class="sessionWarningMessage">'+r1+'</div>';},close:T,keepAlive:Z,logout:Y,login:X}).setEscapeHandler(function(p1){p1.reject();}).setModel(s).setModel(new i({bundle:j1()}),'i18n'));});});}function T(){r&&r.then(function(e){e.close();});}function V(e){o1._bDisableUI=e;if(e){T();}}function W(){return new Promise(function(e){var i=e1('INVALIDATE');if(a.isServiceAllowed(i)){a.invokeService(i).always(e);}else{e();}});}function X(){W().then(function(){var e=i1();if(!e){e='/login';var i=window.pageHeaderJsonData;var p1=i&&i.companyId;if(p1){e+='?company='+encodeURIComponent(p1);}}L.gotoURL(U.ensureBaseDomain(e),true);});}function Y(){V(true);F('logout');if(window.TopNavLogout){TopNavLogout.startLogout();}else{sap.ui.require(['sap/sf/surj/shell/util/TopNavLogout'],function(){if(window.TopNavLogout){window.TopNavLogout.startLogout();}else{$.sap.log.error('TopNavLogout could not be loaded.');}});}}function Z(){var e=e1('KEEP_ALIVE');if(a.isServiceAllowed(e)){a.invokeService(e)}else if(U.isBaseDomainCORSEnabled()){$.ajax({url:U.ensureBaseDomain('/sf/protected/cors'),xhrFields:{withCredentials:true,}});}}function a1(){return o1._oConfigPromise||new Promise(function(i,p1){var q1=window.pageHeaderJsonData;var r1=q1&&q1.settings;if(r1&&r1.results){r1=r1.results.reduce(function(x1,y1){x1[y1.key]=y1.value;return x1;},{});}var s1=r1&&r1.sessionTimeoutConfigs;if(!s1){var t1=document.getElementById('sessionTimeoutConfigs');if(t1){s1=t1.content||t1['data-content'];}}function u1(r1){var v1=r1.timeUntilExpires&&r1.timeUntilExpires>0;if(v1){var x1=Math.round(r1.timeUntilExpires/60);var y1=r1.timeUntilWarning;if(isNaN(y1)||y1>=x1||y1<=0){r1.timeUntilWarning=k;}else{r1.timeUntilWarning=y1;}}return v1;}if(s1){var v1=false;try{var r1=JSON.parse(s1.replace(/([{,])(\w*):/g,'$1"$2":'));if(u1(r1)){i(r1);v1=true;}}catch(e){$.sap.log.error('Error parsing settings: ',e);}if(!v1){p1('invalidSettings: '+s1);}}else{var w1=e1('CONFIG');if(a.isServiceAllowed(w1)){a.invokeService(w1).then(function(r1){if(u1(r1)){i(r1);}else{p1('invalidSettings: '+JSON.stringify(oResponse));}},p1.bind(null,'serverError'));}else{p1('missingConfig');}}});}function b1(e){s.setProperty('/addonMessage',e);}function c1(){return s.getProperty('/params/type')=='timeout';}function d1(e){if(e.type=='sessionTimedOut')G();}function e1(e){return $.extend({},B,m[e]);}function f1(e,i,p1){n.attachEvent(e,r1);var q1=_[e]=_[e]||[];q1.push({oListener:i,fEventHandler:r1});function r1(s1){var t1;if(typeof p1=='function'){t1=p1;}else{t1=i[p1||'handleEvent'];}t1.call(i,$.extend({type:s1.getId()},s1.getParameters()));}}function g1(e,p1){var q1=_[e];if(q1){for(var i=q1.length-1;i>=0;i--){if(q1[i].oListener===p1){n.detachEvent(e,q1[i].fEventHandler);q1.splice(i,1);}}}}function h1(e,i){R().then(function(p1){p1.attachAfterClose(function(q1){if(s.getProperty('/params/type')=='warning'){e.call(i,q1);}});});}function i1(){if(window.AjaxServiceMeta&&AjaxServiceMeta.timeoutUrl){return AjaxServiceMeta.timeoutUrl;}else if(window.AjaxService&&AjaxService.getRedirectUrl){return AjaxService.getRedirectUrl();}return window.timeout_redirect_url;}function j1(){return sap.ui.getCore().getLibraryResourceBundle('sap.sf.surj.shell.i18n');}function k1(e){if(!o){o=document.title;}document.title=e;}function l1(){if(o){document.title=o;o=null;}}n.attachEvent('stateChanged',function(e){var i=e.getParameter('type');if(i=='alive'){l1();}else{if(i=='warning'){if(l){k1(j1().getText('COMMON_SESSION_ABOUT_TO_TIME_OUT'));}else{l1();}}else if(p){k1(j1().getText('COMMON_SUCCESSFULLY_LOGGED_OUT'));}else{k1(j1().getText('COMMON_SESSION_EXPIRED_MESSAGE'));}}});function m1(e){var i=!!o1._bConsiderActivity;var p1=!!e;if(i!=p1){o1._bConsiderActivity=p1;var q1=(D.browser.safari||window.document.compatMode=='BackCompat')?window.document.body:window.document.documentElement;$(q1)[e?'bind':'unbind'](d.reduce(function(r1,s1){r1[s1]=n1;return r1;},{}));}}function n1(e){o1._iLastUserActivity=new Date().getTime();}var o1=window.SFSessionTimeout={start:u,whenStarted:w,addEventListener:f1,removeEventListener:g1,setSessionTimedOutAddonMsg:b1,getTimeoutSettings:a1,isSessionExpired:c1,reset:C,invalidateSession:W,cleanup:x,timeoutAfter:O,endSession:K,timeout:H,keepAlive:Z,extendSession:Z,ignoreUserActivity:m1.bind(null,false),considerUserActivity:m1.bind(null,true),disableUIDisplay:V.bind(null,true),enableUIDisplay:V.bind(null,false),updateTimeoutEstimate:F,_showSessionTimedOutDialog:H,_keepAlive:Z,handleEvent:d1,sessionTimer:{cleanup:x,timedOut:G,addEventListener:f1,removeEventListener:g1,sessionTimeoutController:{invalidateSession:W}},warningDlg:{attachAfterClose:h1},getTimerDialog:R,setTimeout:window.setTimeout,clearTimeout:window.clearTimeout,setInterval:window.setInterval,clearInterval:window.clearInterval,resetTimerState:t,getObservable:function(){return n;},model:s,getLoginUrl:i1,recordUserActivity:n1,login:X,logout:Y,getCurrentTimeoutEstimate:function(){return o1._iTimeoutEstimate;}};['setInitialLastPageVisited','clearLastPageVisited','setCurrentPageAsLastVisited'].forEach(function(e){SFSessionTimeout[e]=function(){var i=window.LastPageVisitedUtil;var p1=i&&i[e];if(p1){p1.apply(i,arguments);}};});return o1;});
