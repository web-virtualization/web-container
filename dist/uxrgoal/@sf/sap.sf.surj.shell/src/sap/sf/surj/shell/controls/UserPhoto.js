jQuery.sap.declare("sap.sf.surj.shell.controls.UserPhoto");jQuery.sap.require("sap.sf.surj.shell.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.sf.surj.shell.controls.UserPhoto",{metadata:{library:"sap.sf.surj.shell"}});sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/base/DataType','sap/ui/Device','sap/ui/core/Icon','../util/UserPhotoUtil','../util/NameFormatter','../util/Config','../util/DeferredUtil','../util/Util'],function($,C,D,a,I,U,N,b,c,d){var l='sap.sf.surj.shell';var p=l+'.controls';var P=$.sap.getObject(p,false);var e={circle:false,cropping:'MIDDLE_MIDDLE',fullNameInitials:false,maxHeight:30,minFontSize:8};var i=sap.ui.resource('sap.sf.surj.shell.img.userphoto','');var f={P_180_240:i+'UserPhotoPlaceholder_180x240.png',P_60_80:i+'UserPhotoPlaceholder_60x80.png',S_112:i+'UserPhotoPlaceholder_112x112.png',S_50:i+'UserPhotoPlaceholder_50x50.png',S_30:i+'UserPhotoPlaceholder_30x30.png'};var g={PORTRAIT_180_240:{width:'180px',height:'240px',fullNameInitials:true,placeholder:f.P_180_240},PORTRAIT_60_80:{width:'60px',height:'80px',placeholder:f.P_60_80},CIRCLE_234:{circle:true,width:'234px',height:'234px',placeholder:f.S_112},CIRCLE_180:{circle:true,width:'180px',height:'180px',placeholder:f.S_112},CIRCLE_140:{circle:true,width:'140px',height:'140px',placeholder:f.S_112},CIRCLE_90:{circle:true,width:'90px',height:'90px',placeholder:f.S_112},CIRCLE_40:{circle:true,width:'40px',height:'40px',placeholder:f.S_50},CIRCLE_64:{circle:true,width:'64px',height:'64px',placeholder:f.S_50},SQUARE_112:{width:'112px',height:'112px',placeholder:f.S_112},SQUARE_64:{width:'64px',height:'64px',placeholder:f.S_50},SQUARE_50:{width:'50px',height:'50px',placeholder:f.S_50},SQUARE_40:{width:'40px',height:'40px',placeholder:f.S_50},SQUARE_30:{width:'30px',height:'30px',placeholder:f.S_30}};var h={LOCAL:'localpicture',EDU:'eduPhoto'};var j={userId:['string',null],userIdEncoded:['string',null],urlType:[h.LOCAL,h.EDU,null],photoType:['string',null],clientPhotoCachingEnabled:['boolean',null],baseUrl:['string',null],mod:['string','number',null]};var k={photoType:'quickCard'};var m={width:['string','number',null],height:['string','number',null],placeholder:['string',null],circle:['boolean',null],textOnSilhouette:['initial','full',null],css:['string',null],imageCss:['string',null],nameCss:['string',null],maxHeight:['number',null],minFontSize:['number',null]};var n={localpicture:{photoAction:'ps_p_action',photoType:'p_type',userId:'ps_p_uid'},eduPhoto:{photoType:'photo_type',userId:'user_id',userIdEncoded:'user_id_encoded'}};var o=$.extend(D.createType(p+'.PhotoProfile',{isValid:function(V){var T=typeof V;if(typeof V=='string'){return!!g[V]}else{return b.validate(V,m);}}}),g);var q=D.createType(p+'.UserPhotoSrc',{isValid:function(V){return b.validate(V,['string',null,j]);}});$.sap.setObject(p+'.PhotoProfile',o);$.sap.setObject(p+'.UserPhotoSrc',q);$.sap.setObject(p+'.Cropping',{START:'START',END:'END',BOTH:'BOTH',SCALE:'SCALE'});$.sap.setObject(p+'.NameDirection',{NORTH:'NORTH',EAST:'EAST',WEST:'WEST',SOUTH:'SOUTH',CENTER:'CENTER'});var r=b.createDataType(p+'.UserInfo',{userId:['string',null],firstName:['string',null],mi:['string',null],lastName:['string',null],photoSrc:[b.dataType(p+'.UserPhotoSrc'),null],hiResPhotoSrc:[b.dataType(p+'.UserPhotoSrc'),null]});var s=C.extend(p+'.UserPhoto',{metadata:{library:l,interfaces:[p+'.IUserPhoto'],properties:{user:p+'.UserInfo',options:{type:'object',defaultValue:null},profile:p+'.PhotoProfile',horizontalCrop:{type:p+'.Cropping',defaultValue:P.Cropping.BOTH},verticalCrop:{type:p+'.Cropping',defaultValue:P.Cropping.BOTH},nameDirection:{type:p+'.NameDirection',defaultValue:P.NameDirection.SOUTH},focusable:'boolean',showUserName:'boolean',showHoverBorder:'boolean',keys:{type:'string[]'},nameWidth:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},wideAsPhoto:'boolean',tallAsPhoto:'boolean',shrinkNameToFit:'boolean',showNameWhenNoPhoto:{type:'boolean',defaultValue:true},passedInNameStyle:'string',useMButtonStyles:'boolean',buttonType:'string',splitName:{type:'boolean',defaultValue:false},useAvatar:{type:'boolean',group:"Appearance",defaultValue:false},displayShape:{type:"any",group:"Appearance",defaultValue:'Circle'},displaySize:{type:"any",group:"Appearance",defaultValue:'M'},showMenuIcon:'boolean',highlightText:'string',ariaLabel:'string'},aggregations:{_menuIcon:{type:'sap.ui.core.Icon',visibility:'hidden',multiple:false}},events:{ready:{},click:{},mouseover:{},mouseout:{},touchstart:{},touchend:{},keydown:{}}},onAfterRendering:function(E){var y=this.$();this._bindDomEvents(y);if(this.getFocusable()){y.attr('type','button');}if(!this.mAspectRatio){this._bindImageEvents($('img.surjUserPhotoImg',y));}else{this._updateStyles();}if(this.getShrinkNameToFit()){this._shrinkNameToFit(y);}},onkeydown:function(E){var y;if(E.ctrlKey&&E.shiftKey&&E.keyCode==49){y='control-shift-1';}if(E.which===jQuery.sap.KeyCodes.SPACE||E.which===jQuery.sap.KeyCodes.ENTER){this._activeButton();}this.fireKeydown({keyEvent:E,keyCombo:y});},onkeyup:function(E){if(E.which===jQuery.sap.KeyCodes.SPACE||E.which===jQuery.sap.KeyCodes.ENTER){this._inactiveButton();}},ontouchstart:function(E){if(E.targetTouches.length===1){this._activeButton();}},ontouchend:function(){this._inactiveButton();},ontouchcancel:function(){this._inactiveButton();},_activeButton:function(){if(this.getUseMButtonStyles()){this.$("inner").addClass("sapMBtnActive");}},_inactiveButton:function(){if(this.getUseMButtonStyles()){this.$("inner").removeClass("sapMBtnActive");}},setUser:function(y,z){var B=this.getUseAvatar();this.setProperty('user',y,!B);this.refreshImage(z);},refreshImage:function(y){if(this.getUseAvatar()){var z=this._oAvatar;z&&z.setSrc(this.getPhotoSrc());return;}var E=this.$();var R=$('img.surjUserPhotoImg',E).removeClass('surjUserPhotoImg');var B=R.length||$('.surjUserPhotoWrapper',E);this.mAspectRatio=null;if(R.length||B.length){var F=$('<img class="surjUserPhotoImg">').attr({src:this.getPhotoSrc(),title:this.getTooltip_AsString()||this.getFullName(),alt:this.getTooltip_AsString()||this.getFullName()}).css(t.getImageStyles(this));this._bindImageEvents(F);if(R.length==0){B.prepend(F);}else if(y){F.insertAfter(R);R.css({position:'absolute'}).fadeOut(function(){R.remove();});}else{R.replaceWith(F);}}},_bindImageEvents:function(y){var _=this;y&&y.length&&y.bind('load',function(){u(this).done(function(z){_.mAspectRatio=z;_._updateStyles();_.fireReady();});}).bind('fail',function(){_.mAspectRatio=null;_.mBackupImage=true;_.refreshImage();});},_bindDomEvents:function(E){var _=this;$.each(['click','mouseover','mouseout','touchstart','touchend'],function(y,z){E.bind(z,function(){_.fireEvent(z,{user:_.getUser()});});});},_shrinkNameToFit:function(E){var y=this.getProfile();$('.surjUserPhotoName, .surjUserPhotoNameNoPhoto',E).each(function(){var E=$(this);var z=parseInt(E.css('width'))||parseInt(E.css('max-width'));if(!isNaN(z)){var F=x(E.text(),this,$.extend({},y,{width:z}));E.css('font-size',F);}});},_updateStyles:function(){var E=this.$();if(E.length){var S=t.getImageStyles(this);S&&$('.surjUserPhotoImg',E).css(S);S=t.getNameStyles(this);S&&$('.surjUserPhotoName',E).css(S);S=t.getImageWrapperStyles(this);S&&$('.surjUserPhotoWrapper',E).css(S);}},updateStyles:function(){this._updateStyles();},getProfile:function(){return o.parse(this.getProperty('profile'));},getFullName:function(){var y=this.getUser();if(!y){return'';}var F=y.name||y.fullName;if(F){return F;}else{return N.format(y);}},getNameInitials:function(){return U.formatInitials(this.getUser());},getNameLines:function(){if(this.getSplitName()){return N.splitFullName(this.getUser());}else{return[this.getFullName()];}},hasPhoto:function(){var y=this.getUser();return y&&y.photoSrc;},getPhotoSrc:function(){var y=this.getUser();var z=this.getUseAvatar();if(!y){return z?'sap-icon://person-placeholder':null;}var B=y.photoSrc;if(v()){B=y.hiResPhotoSrc||B;}if(B==null||this.mBackupImage){var E=this.getProfile();if(E.placeholder){return z?null:E.placeholder;}else{return z?null:i+'UserPhotoPlaceholder_180x240.png';}}else{return q.parse(B);}},setOptions:function(O){this.setProperty('options',O,true);var M=this.getMetadata();for(var y in O){if(M.hasProperty(y)){this.setProperty(y,O[y]);}}},getAvatar:function(){if(!this._oAvatar){$.sap.require('sap.f.Avatar');this._oAvatar=new sap.f.Avatar({src:this.getPhotoSrc(),initials:this.getNameInitials(),displayShape:this.getDisplayShape(),displaySize:this.getDisplaySize(),tooltip:this.getFullName()}).addStyleClass('surjUserPhotoWrapper');}return this._oAvatar;},getAccessibilityInfo:function(){return{description:this.getTooltip_AsString()||this.getFullName()};}});var t=P.UserPhotoRenderer={render:function(R,y){var T=y.getFocusable()?'button':'div';var S=y.getShowUserName();var z=y.getNameDirection();var B=y.getTooltip_AsString();var E=y.getProfile();var F=y.getAriaLabel();R.write('<',T);R.writeControlData(y);if(E.css){R.addClass(E.css);}if(y.getUseMButtonStyles()){R.addClass('sapMBtn');}R.addClass('surjUserPhoto');if(y.getShowHoverBorder()){R.addClass('surjUserPhotoHighlight');}if(S){R.addClass('surjUserPhotoName-'+z);}if(E.circle){R.addClass('surjUserPhotoCircle');}if(E.innerCss){R.addClass(E.innerCss);}R.writeClasses();if(B){R.write(' title="');R.writeEscaped(B);R.write('"');}if(F){R.write(' aria-label="');R.writeEscaped(F);R.write('"');}R.write('><div');R.writeAttribute('id',y.getId()+'-inner');R.addClass('surjUserPhotoInner');if(S&&z=='CENTER'){R.addClass('surjUserPhotoCentered');}if(y.getUseMButtonStyles()){var G=y.getButtonType()||'Default';R.addClass('sapMBtn'+G);R.addClass('sapMBtnHoverable sapMBtnInner sapMFocusable');if(a.browser.internet_explorer||a.browser.edge){R.addClass('sapMIE');}}R.writeClasses();R.write('>');if(y.getUseMButtonStyles()&&(a.browser.internet_explorer||a.browser.edge)){R.write('<span class=\"sapMBtnFocusDiv\"></span>');}if(S){switch(z){case'WEST':case'NORTH':this.renderName(R,y);this.renderImage(R,y);break;case'CENTER':this.renderImage(R,y);this.renderName(R,y);break;default:this.renderImage(R,y);this.renderName(R,y);}}else{this.renderImage(R,y);}if(y.getShowMenuIcon()){var M=y.getAggregation('_menuIcon');if(!M){M=new I({src:'sap-icon://slim-arrow-down'});M.setTooltip(B);y.setAggregation('_menuIcon',M);}R.renderControl(M);}R.write('</div>');R.write('</',T,'>');},renderImage:function(R,y){var z=y.getUseAvatar();if(z){R.renderControl(y.getAvatar());return;}var B=y.getProfile();var E=y.getPhotoSrc();var F=y.getNameDirection();R.write('<div');R.addClass('surjUserPhotoWrapper');if(B.imageCss){R.addClass(B.imageCss);}R.writeClasses();w(R,this.getImageWrapperStyles(y));R.write('>');if(E){R.write('<img class="surjUserPhotoImg"');R.writeAttribute('src',E);R.writeAttributeEscaped('title',y.getTooltip_AsString()||y.getFullName());R.writeAttributeEscaped('alt',y.getTooltip_AsString()||y.getFullName());w(R,this.getImageStyles(y));R.write('/>');}if(!y.hasPhoto()&&y.getShowNameWhenNoPhoto()&&!y.getShowUserName()){R.write('<div class="surjUserPhotoNameNoPhoto">');if(!$('body').hasClass('nonLatin')&&!B.fullNameInitials){R.writeEscaped(y.getNameInitials());}else{this.renderNameFragments(y,R);}R.write('</div>');}R.write('</div>');},renderName:function(R,y){R.write('<div');var z=y.getProfile();var B=y.getNameDirection();var E=y.getPassedInNameStyle();R.addClass('surjUserPhotoName');if(E){R.addClass(E);}if(z.nameCss){R.addClass(z.nameCss);}var K=y.getKeys();K&&$.each(K,function(F,G){R.addClass('surjUserPhotoHas'+G);});R.writeClasses();w(R,this.getNameStyles(y));R.write('>');this.renderKeysPreName(y,R);this.renderNameFragments(y,R);this.renderKeys(y,R);R.write('</div>');},renderNameFragments:function(y,R){var H=y.getHighlightText();var z=H&&new RegExp(RegExp.escape(H),"i");var K=y.getKeys();var B=K&&K.length>0;B&&R.write('<div class="surjName">');if(y.getSplitName()){$.each(y.getNameLines(),function(E,G){R.write('<span');R.addClass('surjNameFragment');R.addClass('surjNameFragment'+E);R.writeClasses();R.write('>');if(H){R.write($.sap.encodeHTML(G).replace(z,function(J){return'<em>'+J+'</em>';}));}else{R.writeEscaped(G);}R.write('</span>');});}else{var F=y.getFullName();if(H){R.write($.sap.encodeHTML(F).replace(z,function(E){return'<em>'+E+'</em>';}));}else{R.writeEscaped(F);}}B&&R.write('</div>');},renderKeysPreName:function(y,R){var z=y.getUser();var K=y.getKeys();K&&$.each(K,function(B,E){if(E=='PHONE'){var V=z&&z.keys&&z.keys[E];R.write('<div');R.addClass('globalFloatRight');R.addClass('surjUserInfoKey');R.addClass('surjUserInfoKey'+E);R.writeClasses();R.write('>');V&&R.writeEscaped(V);R.write('</div>');}});},renderKeys:function(y,R){var z=y.getUser();var K=y.getKeys();K&&$.each(K,function(B,E){if(E!='PHONE'){var V=z&&z.keys&&z.keys[E];R.write('<div');R.addClass('surjUserInfoKey');R.addClass('surjUserInfoKey'+E);R.writeClasses();R.write('>');V&&R.writeEscaped(V);R.write('</div>');}});},getImageWrapperStyles:function(y){var z=y.getProfile();var S={};if(z.width){S.width=z.width;}if(z.height){S.height=z.height;}return S;},getImageStyles:function(y){var z=y.mAspectRatio;var B=y.getProfile();var S;if(z){var E=B.width;var F=B.height;if(!E||!F){var W=$('.surjUserPhotoWrapper',y.$());if(!W.length){return{};}else{if(W.css('width')==="100%"){return{};}else{E=W.css('width');F=W.css('height');}}}var G=parseInt(E,10);var H=parseInt(F,10);var J=/^[\d\.]+(\w+)$/.exec(E);if(J){var K=J[1];var L=G/H;var M=z>L;var O=M?y.getHorizontalCrop():y.getVerticalCrop();if(O=='SCALE'){M=!M;O=M?y.getHorizontalCrop():y.getVerticalCrop();}var Q,R;if(M){Q=H;R=Math.round(H*z);}else{R=G;Q=Math.round(G/z);}S={opacity:1,width:R+K,height:Q+K};var T=G-R;var V=H-Q;switch(O){case'SCALE':case'BOTH':if(M){S['margin-left']=Math.round(T/2)+K;}else{S['margin-top']=Math.round(V/2)+K;}break;case'START':if(M){S['margin-left']=-T+K;}else{S['margin-top']=-V+K;}break;}}}else{S={opacity:'0.1'};}return S;},getNameStyles:function(y){var S={display:'','margin-left':'0','margin-right':'0','min-height':'0'};if(y.getShowUserName()){var z=y.getProfile();var B=y.getNameDirection();var E=y.getNameWidth();if(E){S.width=E;}else if(y.getWideAsPhoto()){S.width=z.width;}else if(y.getTallAsPhoto()){var F=B=='EAST'?'left':'right';S['min-height']=z.height;S['margin-'+F]=z.width;}}else{S.display='none';}return S;}};$.extend(o,{parse:function(V){if(V===undefined){return o.parse('PORTRAIT_180_240');}function y(R){if(typeof R.width=='number'){R.width=R.width+'px';}if(typeof R.height=='number'){R.width=R.height+'px';}}if(typeof V=='string'){var R=$.extend({css:'surjUserPhoto-'+V},e,g[V]);y(R);return R;}else{for(var K in g){if(V===g[K]){return o.parse(K);}}if(o.isValid(V)){var R=$.extend({},V);y(R);return V;}else{throw new Error('[UserPhoto] Invalid profile object provided');}}}});$.extend(q,{TYPES:h,parse:function(V){if(q.isValid(V)){return U.formatUserPhoto(V);}throw new Error('[UserPhoto] Invalid user info');},getPhotoMod:U.getPhotoMod});var A={};function u(E){var y=E.src;if(!A[y]){var z=$.Deferred();A[y]=z.promise();setTimeout(function(){var B=$(E);var W=B.width();var H=B.height();var F=W/H;if(!isNaN(F)&&F<2&&F>0.5){z.resolve(F);}else{var G=new Image();G.onload=function(){z.resolve(G.width/G.height);};G.src=E.src;}},100);}return A[y];}function v(){return window.devicePixelRatio&&(window.devicePixelRatio>1);}function w(R,S){if(S){$.each(S,function(y,V){R.addStyle(y,V);});R.writeStyles();}}function x(T,y,z){function B(H,J){return Math.min(z.maxHeight,Math.max(z.minFontSize,Math.floor(H*J)-1));}function E(T,y,H){y=y||document.body;H=H||'1em';T=T||'M';var J=document.createElement('div');J.style.display='inline-block';J.style.lineHeight='1em';J.style.fontSize=H;J.style.padding=0;J.style.visibility='hidden';J.appendChild(document.createTextNode(T));y.appendChild(J);var K=[Math.max(J.offsetWidth,J.scrollWidth),J.offsetHeight];y.removeChild(J);return K;}var F=E(T,y);var G=E(null,y);var S=E(T,y,z.minFontSize+'px');if((S[0]<z.width)&&(G[1]<F[1])){return B(z.minFontSize,z.width/S[0])+"px";}else if(z.maxHeight&&F[1]>z.maxHeight){return B(G[1],z.maxHeight/F[1])+"px"}return'1em';}return s;});
