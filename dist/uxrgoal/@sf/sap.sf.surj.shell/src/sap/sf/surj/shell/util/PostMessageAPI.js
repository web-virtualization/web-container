sap.ui.define(['sap/ui/base/EventProvider','./Util'],function(E,U){'use strict';var P=new E();P._msgPrefix='POST_ID_';P._msgId=0;P.handleMessage=function(o){if(!(o&&this.isTargetOrigin(o.origin))){return;}var m=o.data;if(typeof m==='string'){try{m=JSON.parse(m);}catch(e){return;}}if(m&&typeof m.request_id=='string'&&typeof m.service=='string'){var a={data:m,originalEvent:o};this.fireEvent('message',a);this.fireEvent(this.getMessageEventId(m),a);}};P.sendRequest=function(s,r,S){var a=this;return new Promise(function(b,c){var R=a.getNextRequestId();var m={type:'request',service:s,body:r||{},request_id:R};if(!S){a.attachEventOnce(a.getResponseEventId(s,R),function(o){var f=o.getParameter('data');if(f&&f.status=='success'){b(f.body);}else{c(f.body);}});}var e=a.postMessage(m);if(e&&S){b({status:'success'});}if(!e){c({status:'failure',body:{message:'could not postMessage to targetWindow'}});}});};P.sendResponse=function(r,s,R){return this.postMessage({type:'response',status:s,service:r.service,request_id:r.request_id,body:R});};P.attachRequestHandler=function(s,h){this.attachEvent(this.getRequestEventId(s),h);};P.attachRequestHandlerOnce=function(s,h){this.attachEventOnce(this.getRequestEventId(s),h);};P.detachRequestHandler=function(s,h){this.detachEvent(this.getRequestEventId(s),h);};P.postMessage=function(m){if(this.isSupported()){var w=this.getTargetWindow();var T=this.getTargetOrigin();P.fireEvent('messageSent',{data:m,targetWindow:w,targetOrigin:T});w.postMessage(JSON.stringify(m),T);return true;}return false;};P.isTargetOrigin=function(o){var T=this.getTargetOrigin();return T=='*'||T==o;};function g(){var a=['parentFrameOrigin'];for(var i=0;i<a.length;i++){var p=U.findURLParam(a[i]);if(p){return d(p);}}return null;}function d(u){if(u){u=decodeURIComponent(u).toLowerCase();var p=/^(.*)\/*$/.exec(u);if(p){u=p[1];}}return u;}function t(p){return p?p.split('|').map(d):null;}P.setTargetOrigin=function(T){this._sTargetOrigin=T;};P.getTargetOrigin=function(){if(this._sTargetOrigin){return this._sTargetOrigin;}var p=null;var a=window.pageHeaderJsonData;if(a&&a.settings){p=t(a.settings['inframe.parentFrameOriginUrl']);}if(!p){var m=document.getElementById('inframe.parentFrameOriginUrl');p=t(m&&m.getAttribute('content'));}if(p&&p.length>0){if(p.length>1){var b=g();if(b&&p.indexOf(b)>=0){this._sTargetOrigin=b;}}this._sTargetOrigin=this._sTargetOrigin||p[0];}return this._sTargetOrigin;};P.isSupported=function(){return this.getTargetOrigin()!=null&&this.getTargetWindow()!==window.self;};P.start=function(){if(!this._fnHandler){this._fnHandler=this.handleMessage.bind(this);this.getSourceWindow().addEventListener('message',this._fnHandler);}};P.stop=function(){if(this._fnHandler){this.getSourceWindow().removeEventListener('message',this._fnHandler);this._fnHandler=null;}};P.getResponseEventId=function(s,r){return this.getMessageEventId({type:'response',service:s,request_id:r});};P.getRequestEventId=function(s){return this.getMessageEventId({type:'request',service:s});};P.getMessageEventId=function(m){if(m){var s=m.type=='response'?':'+m.request_id:'';return m.type+':'+m.service+s;}return null;};P.getNextRequestId=function(){return this._msgPrefix+(++this._msgId);};P.getSourceWindow=function(){return this._oSourceWindow||window;};P.setTargetWindow=function(T){this._oTargetWindow=T;};P.getTargetWindow=function(){if(this._oTargetWindow){return this._oTargetWindow;}return window.parent;};P.start();return P;});
