sap.ui.define('sap/sf/surj/shell/util/ActionSearchUtil',['jquery.sap.global','sap/sf/surj/shell/util/SearchUtil','sap/sf/surj/shell/util/DeferredUtil','sap/sf/surj/shell/util/LinkUtil','sap/sf/surj/shell/util/Util','sap/sf/surj/shell/util/SMRF','jquery.sap.storage'],function($,SearchUtil,DeferredUtil,LinkUtil,Util,SMRF){var DEFAULT_PAGE_SIZE=10;var ActionSearchUtil={isRunningInContext:isRunningInContext,showRedirectConfirmationMessage:showRedirectConfirmationMessage,createResponse:createResponse,registerQuickcardHandler:function(o){var c=$.extend({actionContext:window,subjectExpected:false},o);var h;if(c.subjectExpected){h=$.proxy(o.actionHandler,o.actionContext);}else{h=function(s,r,a,t){return c.actionHandler.call(c.actionContext,$.extend({},{subject:s,target:t,referenceId:r},a));};}$.sap.setObject(o.actionName+'.openActionQuickCard',h);},performAction:function(i,f){var a=i.item;if(a.transitive&&!i.subject){throw new Error('[ActionSearchUtil] Make sure to select a subject first.');}if(!f&&!isActionableInCurrentContext(a)){redirectAction(i);}else{if(!i.skipHit){ActionSearchUtil.hitActionSearchItem(i);}if(isAdminLink(a)){handleAdminLink(i);}else{switch(a.actionType){case'dynamicLink':case'quickcard':return handleQuickcardAction(i);case'link':handleLinkAction(i);break;}}}},hitActionSearchItem:function(i){var a=i.item;var p={totalCount:i.totalCount||0,activateIndex:i.activateIndex||0,showAllClicked:!!i.showAllClicked,actionId:a.actionId,actionLabel:a.actionLabel,keywords:(i.criteria&&i.criteria.searchValue)||null,score:a.score||0,actionHits:a.actionHits||0};return DeferredUtil.createDeferred($.extend(({ODataService:{data:p},ajaxService:{arguments:[p]}})[SERVICE_TYPE],HIT_ACTION_SEARCH_ITEM_SERVICE[SERVICE_TYPE]));},generateRedirectLink:function(i,f){var u=getRedirectLinkUrl(i);if(Util.isRunningBaseDomain()){var s=getActionStorage();var p,P;if(s){var a=''+new Date().getTime();s.put(a,i);p='actionToken';P=a;}else{p='actionFailure';P='storage';}return Promise.resolve(composeUrl(u,p,P));}else if(!f){return Util.getMessageService(getRedirectDeepLink(i),true).then(function(m){return m.sendTransaction({request:'performAction',response:'actionRedirect',parameter:i}).then(function(u){return Util.ensureBaseDomain(u);});}).catch(function(r){$.sap.log.error('Could not generate redirect action link',r);return Promise.resolve(composeUrl(u,'actionFailure','messageService'));});}else{return Promise.resolve(composeUrl(u,'actionFailure','messageService'));}},checkRedirectAction:function(){$.when(DeferredUtil.whenUI5LibraryCSSReady(),DeferredUtil.whenLowPriority('LOWEST')).done(function(){var s=getActionStorage();if(s){var a=Util.findURLParam('actionToken');if(a){var i=s.get(a);if(i){s.remove(a);ActionSearchUtil.performAction(i,true);}}}});}};SearchUtil.register('TransitiveAction',{search:function(c){var r={queryType:c.queryType,keywords:c.searchValue,keys:c.keys,actionStartNum:0,actionPageSize:0,peopleStartNum:0,peoplePageSize:c.maxresults||DEFAULT_PAGE_SIZE,actionId:c.actionId,existingActionIds:c.existingActionIds};return DeferredUtil.createDeferred($.extend(({ODataService:{data:r},ajaxService:{arguments:[r]}})[SERVICE_TYPE],SEARCH_SERVICE[SERVICE_TYPE])).then(function(R){return createResponse('People',c,normalizeResponse(R),0)||createResponse('Ext',c,R,0);});}});SearchUtil.register('Action',{search:function(c){var r={queryType:'action',keywords:c.searchValue,keys:c.keys,actionStartNum:0,actionPageSize:c.maxresults||DEFAULT_PAGE_SIZE,peopleStartNum:0,peoplePageSize:0,actionId:c.actionId,existingActionIds:c.existingActionIds,sourceType:c.sourceType,requireDeeplinks:!Util.isRunningBaseDomain()&&!Util.isBaseDomainCORSEnabled()};return DeferredUtil.createDeferred($.extend(({ODataService:{data:r},ajaxService:{arguments:[r]}})[SERVICE_TYPE],SEARCH_SERVICE[SERVICE_TYPE])).then(function(R){return createResponse('Action',c,normalizeResponse(R),0);});},selectItem:function(i){ActionSearchUtil.performAction(i);}});SearchUtil.register('CopilotAction',{selectItem:function(i){ActionSearchUtil.performAction(i);}});var DEFAULT_PAGE_DEEPLINK="/sf/start";var ADMIN_DEEPLINK="/sf/admin";var WINDOW_OPTIONS={};function redirectAction(i){showBusyDialog(ActionSearchUtil.generateRedirectLink(i).then(function(u){var p=Util.decodeParam(u);var f=p&&p.actionFailure;showRedirectConfirmationMessage(f,function(w){LinkUtil.gotoURL(u,false,w);});}));}function getRedirectDeepLink(i){var a=i&&i.item;return(a&&i.item.pageContextUrl)||(isAdminLink(a)?ADMIN_DEEPLINK:DEFAULT_PAGE_DEEPLINK)+"?_actionRedirect=true";}function getRedirectLinkUrl(i){return Util.ensureBaseDomain(getRedirectDeepLink(i));}function composeUrl(u,p,P){var o={};o[p]=P;return u+(u.indexOf('?')>=0?'&':'?')+$.param(o);}function getActionStorage(){var a=window.ajaxSecKey;if(a){var s=$.sap.storage('session','_ActionSearch_'+a);if(s.isSupported()){return s;}}return false;}function isAdminLink(a){if(a){var A=a.actionTarget;return a.sourceType=='adminlink'&&typeof A=='string'&&A.indexOf('javascript:')==0;}return false;}function isActionableInCurrentContext(a){var A=a.actionType;var p=a.pageContextUrl;if((A=='link'&&!isAdminLink(a))||p=='*'){return true;}else if(!Util.isRunningBaseDomain()){return false;}if(isAdminLink(a)||p=='/sf/admin'){return!!window.isAdminHomepage;}return p==null||window.location.pathname==p;}function isRunningInContext(p){if(Util.isRunningBaseDomain()){var p=Util.ensureBaseDomain(p);if(p=='/sf/admin'){if(window.isAdminHomepage){return true;}}return window.location.pathname==p;}return false;}function showRedirectConfirmationMessage(f,c){if(!f){c();return;}sap.ui.require(['sap/m/MessageBox'],function(M){var r=sap.ui.getCore().getLibraryResourceBundle('sap.sf.surj.shell.i18n');var y=r.getText('COMMON_Yes');var n=r.getText('COMMON_No');var F=(f?'_'+f:'');M.alert(r.getText('COMMON_Action_Requires_Redirect'+F),{actions:[y,n],onClose:function(a){if(a==y){c();}}});});}function showBusyDialog(p,d){var b,D=false;var t=setTimeout(function(){sap.ui.require(['sap/m/BusyDialog'],function(B){b=!D&&(new B().open());});},d||100);p.catch(function(){}).then(function(){D=true;clearTimeout(t);if(b){b.close();b.destroy();}});}function handleQuickcardAction(i){var a=i.item;var A=a&&a.actionTarget;var F=A&&A.split('|');if(!A){return Promise.resolve();}var g;if(F&&F.length>1){g=F[0].split(';').map(function(f){return f.split(',');});}else{g=[];}var G=0;var s=F&&F[F.length-1];var o=i.actionArgs;if(o&&!$.isArray(o)){o=[o];}if(!$.isArray(o)){var b=i.actionParams||{actionId:a.actionId,actionLabel:a.actionLabel};o=[i.subject,i.referenceId,b,i.target];}function e(){var d=$.sap.getObject(s);var O=d&&d.openActionQuickCard;if(O){return O.apply(d,o);}else{$.sap.log.error('ActionSearchUtil: cannot find '+s+'.openActionQuickCard()');}}function l(d){if(!d||d.length==0){return Promise.resolve();}var S=[];var r=[];d.forEach(function(f){/\.(js|css)$/.test(f)||f.indexOf("ajaxservice:")==0?S.push(f):r.push(f);});var p=[];if(r.length>0){p.push(new Promise(function(f,h){sap.ui.require(r,f,h);}));}if(S.length>0){p.push(Util.includeScripts(S));}return Promise.all(p);}function c(){if(G>=g.length){return Promise.resolve();}else{return l(g[G++]).then(c);}}return c().then(e).catch(function(r){$.sap.log.error('Could not load files, reason: ',r);});}function handleAdminLink(oItemConfig){var oItem=oItemConfig.item;var sUrl=oItem.actionTarget;var sStatement='new '+sUrl.substring(11);function executeAction(){setTimeout(function(){eval(sStatement);},100);}Util.includeScripts(['/ui/admin/js/portlets/admModalLinkComponent.js','/ui/admin/js/launchform/launchForm.js']).then(executeAction);}function handleLinkAction(i){var I=i.item;var u=I.actionTarget;if(u){var p={};var s=i.subject;if(s){p.userid=s.userId;p.username=s.userName;p.id=s.id;}for(var a in p){var v=p[a];u=u.replace('${'+a+'}',typeof v!=undefined?encodeURIComponent(''+v):'');}var l=u.toLowerCase();if(l.indexOf('/')!=0&&l.indexOf('./')!=0&&l.indexOf('#')!=0&&l.indexOf('http://')!=0&&l.indexOf('https://')!=0&&l.indexOf('mailto:')!=0){u=window.location.protocol+'//'+u;}LinkUtil.gotoURL(Util.ensureBaseDomain(u),!Util.isBizXDomain(u)&&!Util.isBaseDomainCORSEnabled(),getWindowOptions(I));}}function getWindowOptions(i){return i.linkType==="3"?{}:undefined;}SearchUtil.register('ActionPeople',{search:function(c){var r={queryType:'people_action',keywords:c.searchValue,keys:c.keys,actionStartNum:0,actionPageSize:c.maxresults||DEFAULT_PAGE_SIZE,peopleStartNum:0,peoplePageSize:c.maxresults||DEFAULT_PAGE_SIZE,actionId:c.actionId,existingActionIds:c.existingActionIds,requireDeeplinks:!Util.isRunningBaseDomain()&&!Util.isBaseDomainCORSEnabled()};return DeferredUtil.createDeferred($.extend(({ODataService:{data:r},ajaxService:{arguments:[r]}})[SERVICE_TYPE],SEARCH_SERVICE[SERVICE_TYPE])).then(function(R){R=normalizeResponse(R);var I=[];SEARCH_TYPES.forEach(function(t){var o=createResponse(t,c,R,0);if(o&&o.items&&o.items.length>0){I.push(o);}});if(I.length==1){return I[0];}else{$.each(I,function(i,o){var t=o.items;var m=TYPE_INFO[o.type].multipleLimit;if(t&&t.length>m){o.items=t.splice(m,t.length-m);I[i]={type:o.type,items:t,hasMore:true,totalCount:o.totalCount,more:function(){return $.Deferred().resolve(o).promise();}};}});return{items:I,multiple:I.length>1,hasMore:false,type:'ActionPeople'};}});}});var SERVICE_TYPE=Util.findURLParam('odataActionSearch')!='false'?'ODataService':'ajaxService';var SEARCH_SERVICE={ODataService:{type:'ODataService',serviceName:'queryActionSearch',method:'POST'},ajaxService:{type:'ajaxService',serviceName:'actionSearchController',serviceMethod:'query'}};var LAZY_SEARCH_SERVICE={ODataService:{type:'ODataService',serviceName:'lazyQueryActionSearch',method:'POST'},ajaxService:{type:'ajaxService',serviceName:'actionSearchController',serviceMethod:'lazyQuery'}};var HIT_ACTION_SEARCH_ITEM_SERVICE={ODataService:{type:'ODataService',serviceName:'hitActionSearchItem',method:'POST'},ajaxService:{type:'ajaxService',serviceName:'actionSearchController',serviceMethod:'hitActionSearchItem'}};DeferredUtil.registerODataService({serviceAlias:'_ActionSearch_',serviceName:['queryActionSearch','lazyQueryActionSearch','hitActionSearchItem']});DeferredUtil.finalizeODataRegistry({serviceAlias:'_ActionSearch_'});var SEARCH_TYPES=['Action','CopilotAction','People'];var TYPE_INFO={People:{queryType:'people',resultKey:'peoples',itemsKey:'items',indexKey:'indexRef',countKey:'totalCount',multipleLimit:6},Action:{queryType:'action',resultKey:'actions',itemsKey:'detailList',indexKey:'startIndex',countKey:'totalCount',multipleLimit:3},CopilotAction:{queryType:'copilot_action',resultKey:'copilotActions',itemsKey:'detailList',indexKey:'startIndex',countKey:'totalCount',multipleLimit:3},Ext:{queryType:'ext',resultKey:'exts',itemsKey:'detailList',indexKey:'startIndex',countKey:'totalCount'}};function addActionIds(c,I){var e=c.existingActionIds=c.existingActionIds||[];$.each(I,function(i,o){e.push(o.actionId);});}function normalizeResponse(r){r=DeferredUtil.normalizeODataResponse(r,'GlobalSearchResultVO');if(r.peoples&&r.peoples.items){r.peoples.items.forEach(function(i){i.keys=i.keyValues;delete i.keyValues;if(i.employments){i.employments.forEach(function(e){e.employmentType=e.employmentTypeStr;delete e.employmentTypeStr;});}});}return r;}function createResponse(t,c,r,p,C){C=C||{};var I=TYPE_INFO[t];var R=r&&r[I.resultKey];if(R){var a=R[I.itemsKey];var T=C.totalCount;if(T==null){T=R[I.countKey];}var b=a?a.length:0;var l=0;if(b>0){for(var i=0;i<b;i++){var o=a[i];var d=o[I.indexKey];if(d>l){l=d;}}}var n=p+1;var N;var m=c.maxresults||DEFAULT_PAGE_SIZE;if(l===0||isNaN(l)){N=n*m;}else{N=l+1;}if(t=='Action'||t=='CopilotAction'){addActionIds(C,a);}if(ActionSearchUtil._sampleActions){var s=c&&c.searchValue;var S=C.samples;if(!S){S=SAMPLES[t];if(S&&s){s=s.toLowerCase();S=S.filter(function(g){var L=g.actionLabel||g.label||g.name;if(L&&(''+L).toLowerCase().indexOf(s)>=0){return true;}var k=g.keyValues;if(k){for(var K in k){var v=k[K];if(v&&(''+v).toLowerCase().indexOf(s)>=0){return true;}}}return false;});}else{S=[];}C.samples=S;a.push.apply(a,S);var e=S.length;b+=e;T+=e;}}C.totalCount=T;var f=C.totalReturned=(C.totalReturned||0)+b;var h=b>0&&f<T;return{type:t,items:a,hasMore:h,totalCount:T,more:h?function(){return createLazyDeferred(t,c,N,n,C);}:null};}}function createLazyDeferred(t,c,s,p,C){var i=TYPE_INFO[t];var r={queryType:i.queryType,keywords:c.searchValue,keys:c.keys,actionId:c.actionId,sourceType:c.sourceType};var P={startIndex:s,pageSize:c.maxresults};if(t=='Action'){r.existingActionIds=C.existingActionIds;}return DeferredUtil.createDeferred($.extend(({ODataService:{data:{params:r,pagination:P}},ajaxService:{arguments:[r,P]}})[SERVICE_TYPE],LAZY_SEARCH_SERVICE[SERVICE_TYPE])).then(function(R){return createResponse(t,c,normalizeResponse(R),p,C)||{type:t,items:[],hasMore:false};});}ActionSearchUtil.registerQuickcardHandler({actionName:'_testActionSearch',actionHandler:function(i){sap.ui.require(['sap/m/MessageBox'],function(M){M.alert(JSON.stringify(i,null,4));});}});ActionSearchUtil.registerQuickcardHandler({actionName:'_PP3EditDialog',subjectExpected:true,actionHandler:function(c,i,u){SMRF.load(['/ui/peopleprofile/js/actionSearchPopup.js'],function(){showPP3EditDialog(c,i,u);});}});ActionSearchUtil._sampleActions=('true'==Util.findURLParam('_sampleActions'));var SAMPLES={Action:[{actionLabel:'Sample Quickcard Action',actionTarget:'|_testActionSearch',actionType:'quickcard'},{actionLabel:'Sample adminLink',actionTarget:'javascript:sap.m.Dialog({title:"Hello",buttons:[new sap.m.Button({text:"ok",press:function(e){e.getSource().getParent().close()}})]}).open()',actionType:'link',sourceType:'adminlink'},{actionLabel:'Sample TransitiveAction',actionTarget:'|_testActionSearch',actionType:'quickcard',transitive:true},{actionLabel:'Sample OrgChart',actionTarget:'/sf/orgchart?selected_user=cgrant1',actionType:'link'}],Ext:[{id:'ext1',label:'Ext Label #1'},{id:'ext1',label:'Ext Label #1'}]};$.sap.setObject('sap.sf.surj.shell.util.ActionSearchUtil',ActionSearchUtil);return ActionSearchUtil;});
