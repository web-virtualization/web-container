sap.ui.define('sap/sf/surj/shell/util/ShowMeUtil',['jquery.sap.global','sap/sf/surj/shell/util/DeferredUtil','sap/sf/surj/shell/util/Util','sap/sf/surj/shell/controls/ShowMeCallout'],function($,D,U,S){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle('sap.sf.surj.shell.i18n');var p,h,a,m,s,d,b,u,v,e,t,f,n,g;var j=$.Deferred();var P='sfShowmePlay';var k='width=550,height=434';var R='width=550,height=380';var M='width=550,height=590';var l={init:function(){var c=window.pageHeaderJsonData;b=c&&c.showMeInfo;if(!b||!b.featureEnabled||!b.uploadId){return;}n=b.notAgainPref;Q().done(function(i){s=i;d=V(i);switch(i.state){case'NotExists':if(b.authorPerm){m='author';z();a=new sap.sf.surj.shell.controls.ShowMeCallout({modality:m,isMobile:Z()});if(w()){q();}}break;case'Complete':if(!d||b.authorPerm){m=b.authorPerm?'manage':'play';t=Y(i);u=!i.application||i.application!=b.appId;v=W(i);e=X(i);z();if(t){L('redirect/'+t+'/file.jpg').done(function(f1){f=f1;a=new sap.sf.surj.shell.controls.ShowMeCallout({modality:m,videoTitle:v,videoDesc:e,thumbUrl:f,useDefaultContent:u,isMobile:Z()});if(w()){q();}});}}break;case'Uploading':case'Processing':case'Error':if(b.authorPerm){m='manage';z();}break;}});},handleNotAgain:function(c){B(c);},showPopup:J,_handleCOEvent:o,_resetPopup:function(){p=null;}};function o(c){switch(c.action){case'notAgain':B(c.flag);break;case'manageShowMe':G();break;case'playShowMe':C();break;case'recordShowMe':F();break;case'playShowMeAuthorHelp':E();break;}if(a){a.close();}}function q(){var c=sap.ui.getCore().byId('showMeButton');a.setEventHandler(o);if(j.state()=='resolved'){a.openBy(c);}else{j.done(function(){a.openBy(c);});}}function w(){return!n&&!d1();}var x=['alt_subNavShowMe','subNavShowMe'];function y(){for(var i=0;i<x.length;i++){var c=x[i];if($('#'+c).length>0){return c;}}return null;}function z(){var c=sap.ui.getCore();if(c.byId('showMeButton')){return;}var i=new sap.m.Button('showMeButton',{icon:'sap-icon://play',tooltip:r.getText('COMMON_SHOW_ME'),press:A,customData:new sap.ui.core.CustomData({key:"help-id",value:'bizxHeaderShowMeBtn',writeToDom:true})}).addStyleClass('showMeBtn');i.onAfterRendering=function(){j.resolve();};i.attachBrowserEvent('mouseover',function(){if(a&&!a.isOpen()){g=setTimeout(function(){q();},2000);}});i.attachBrowserEvent('mouseout',function(){if(g){clearTimeout(g);g=null;}});var f1=false;if(b.pageId=='HOME_TAB'){var g1=c.byId('bizXShellCustomHeader');if(g1){f1=true;if($('.surjTopNavHeaderBar .sapMBarRight .company-logo').length>0){var h1=g1.getContentRight().length;g1.insertContentRight(i,h1-1);}else{g1.addContentRight(i);}}}else{var i1=c.byId('bizXPage');if(i1){f1=true;i1.addPlacematButton(i);}}if(!f1){var j1=y();if(j1){i.addStyleClass('globalToolbarIcon');i.placeAt(j1);}}}function A(){switch(m){case'play':C();break;case'manage':G();break;case'author':F();break;}}function B(c){n=c;T('setNotAgainFlag',{flag:JSON.stringify(c)});}function C(){if(p&&!p.closed){p.focus();return;}I(P,k,true);N('widgets/playback').done(function(c){J(P,k,true,false,c);if(a){a.close();}});}function E(){if(h&&!h.closed){h.focus();return;}I(P,k,true,true);O().done(function(c){J(P,k,true,true,c);if(a){a.close();}});}function F(){H('widgets/record',R);}function G(){H('widgets/playback',M);}function H(c,i){if(p&&!p.closed){p.focus();return;}I(b.uploadId,i,true);N(c).done(function(f1){var g1=K();if(g1){f1+='&d='+g1;}f1+='&check_exists=1';J(b.uploadId,i,true,false,f1);if(a){a.close();}});}function I(c,i,f1,g1){if(U.isSafari()){var h1=b.baseUrl?b.baseUrl+'/widgets/loading':'about:blank';p=J(c,i,f1,g1,h1);}else{p=null;}}function J(c,i,f1,g1,h1){if(p){p.location=h1;if(p){p.focus();}}else{i='status=0,toolbar=0,menubar=0,resizable=1,'+i;if(g1){h=window.open(h1,c,i,f1);if(h){h.focus();}}else{p=window.open(h1,c,i,f1);if(p){p.focus();}}if(b&&b.authorPerm){c1();}}}function K(){if(typeof(window.screenX)!='undefined'){return window.screenX+','+window.screenY+','+window.outerWidth+','+window.outerHeight;}return"";}function L(c){return T('signAPIUrl',{path:'/media/'+b.appId+'/'+b.uploadId+'/'+c,uploadId:b.uploadId,uploadIdHash:b.uploadIdHash});}function N(c){var i=c+'/'+b.appId+'/'+b.uploadId;return b1(T('signWidgetUrl',{path:i,uploadId:b.uploadId,uploadIdHash:b.uploadIdHash}).then(function(f1){if(b.userLocale){f1+='&l='+b.userLocale;}if(Z()){f1+='&layout=m';}return f1;}));}function O(){return b1(T('getHowToVideoUrl').then(function(c){if(b.userLocale){c+='&l='+b.userLocale;}return c;}));}function Q(){return L('status').then(function(c){if(c===''){return $.Deferred().reject();}c+=(c.indexOf('?')>=0?'&':'?')+'callback=?';return D.invokeJsonpService(c);});}function T(c,f1){var g1={type:'ajaxService',module:'showme',serviceName:'showMeController'};var h1={setNotAgainFlag:{serviceMethod:'setNotAgainFlag',parameters:['flag']},signAPIUrl:{serviceMethod:'signAPIUrl',parameters:['path','uploadId','uploadIdHash']},signWidgetUrl:{serviceMethod:'signWidgetUrl',parameters:['path','uploadId','uploadIdHash']},getHowToVideoUrl:{serviceMethod:'getHowToVideoUrl'}};var i1=h1[c];var j1=[];$.each(i1.parameters||[],function(i,k1){j1.push(f1[k1]);});return D.invokeService($.extend({arguments:j1},g1,{serviceMethod:c}));}function V(c){return c.meta&&c.meta.draft&&c.meta.draft=='true';}function W(c){return c.meta&&c.meta.title||r.getText('COMMON_SHOW_ME_DEFAULT_VIDEO_TITLE');}function X(c){return(c.meta&&c.meta.description)?c.meta.description:r.getText('COMMON_SHOW_ME_WATCH_VIDEO');}function Y(c){var f1=c.files;if($.isArray(f1)){for(var i=0;i<f1.length;i++){var g1=f1[i];if(g1.type=='image/jpeg'&&parseInt(g1.width)<=300){return g1.id;}}}return null;}function Z(){var c=$('html');return c.hasClass('sapUiMedia-Std-Tablet')||c.hasClass('sapUiMedia-Std-Phone');}var _=0;var a1;function b1(c){sap.ui.require(['sap/m/BusyDialog'],function(i){if(c.state()==='pending'){_++;if(!a1){a1=new i();}a1.open();c.always(function(){if(--_===0){a1.close();}});}});return c;}function c1(){var c=new Date();c.setTime(c.getTime()+120000);document.cookie='showme-busy=true; expires='+c.toGMTString()+'; path=/';}function d1(){return!!e1('showme-busy');}function e1(f1){var g1=f1+='=';var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(g1)===0){return c.substring(g1.length,c.length);}}return null;}$.sap.setObject('sap.sf.surj.shell.util.ShowMeUtil',l);return l;});
